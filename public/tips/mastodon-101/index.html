<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><title>Who Else Wants to Have Their Own Mastodon Server?</title><meta content="keyword1, keyword2, keyword3" name=keywords><meta name=description><meta content="Volkan Özçelik" name=author><link href=https://zerotohero.dev/tips/mastodon-101/ rel=canonical><link href=https://zerotohero.dev/css/includes/scroll-bar.css rel=stylesheet><link href=https://zerotohero.dev/css/styles.css rel=stylesheet><link href=https://zerotohero.dev/css/override.css rel=stylesheet><link href=https://zerotohero.dev/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style> <style>@media (prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:#dadadb;--secondary:#9b9c9d;--tertiary:#414244;--content:#c4c4c5;--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><body id=top><script>if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }</script><script src=https://player.vimeo.com/api/player.js></script><header class=header><nav class=nav><div class=logo><a title="Zero to Hero (Alt + H)" accesskey=h href=https://zerotohero.dev> <svg viewbox="-0.5 -0.5 32 32" height=32 id=High-Voltage--Streamline-Kawaii-Emoji style=position:relative;top:2px;left:4px width=32 xmlns=http://www.w3.org/2000/svg><desc>High Voltage Streamline Emoji: https://streamlinehq.com</desc><path d="M16.244 18.21002a56.048 56.048 0 0 1 -8.1313 -0.8853599999999999 3.3480000000000003 3.3480000000000003 0 0 1 -2.3374 -4.7802C6.500699999999999 11.097999999999999 16.04994 3.35854 21.79548 1.2059a1.14328 1.14328 0 0 1 1.36772 1.68392c-1.2183 1.8599999999999999 -3.5340000000000003 4.0641 -7.88702 8.56716 1.98772 0.124 4.207319999999999 -0.093 6.55216 -0.07688a3.66172 3.66172 0 0 1 3.0534999999999997 1.3813600000000001c0.6975 0.9734 0.97898 2.33058 0.32674000000000003 3.3356 -1.54504 2.37894 -9.10284 9.4054 -13.52468 12.80362 -1.5741800000000001 1.2096200000000001 -2.7565199999999996 1.27596 -3.41 0.26226 -0.39742 -0.6169 0.18166 -1.32618 0.5251399999999999 -1.8258999999999999C10.185979999999999 25.320800000000002 16.182000000000002 18.20754 16.244 18.21002z" fill=#ffe500 stroke-width=1></path><path d="M24.881839999999997 12.76146a3.66172 3.66172 0 0 0 -3.0534999999999997 -1.3813600000000001 52.95544 52.95544 0 0 0 -1.9734599999999998 0.03038 3.472 3.472 0 0 1 2.54696 1.3509799999999998c0.6975 0.9734 0.9796 2.33058 0.32674000000000003 3.3356 -1.5444200000000001 2.37894 -9.10284 9.40478 -13.52468 12.80362a6.66996 6.66996 0 0 1 -0.744 0.496c0.682 0.75144 1.78498 0.6107 3.2209000000000003 -0.496 4.424939999999999 -3.3988400000000003 11.98336 -10.42468 13.52778 -12.80362 0.65286 -1.00502 0.37076 -2.3622 -0.32674000000000003 -3.3356zM20.6832 2.88982c-1.16498 1.77816 -3.3368399999999996 3.87314 -7.33026 7.9918000000000005a0.35773999999999995 0.35773999999999995 0 0 0 0.248 0.60698c0.65596 0.01302 1.33486 0 2.0292600000000003 -0.02294 -0.11656 -0.00496 -0.23994000000000001 0 -0.35525999999999996 -0.00868 4.34 -4.495 6.66066 -6.700340000000001 7.88082 -8.556000000000001a1.1457600000000001 1.1457600000000001 0 0 0 -1.35904 -1.69446c-0.3565 0.1333 -0.7285 0.28892 -1.11104 0.46252a1.09802 1.09802 0 0 1 -0.00248 1.22078z" fill=#f2c100 stroke-width=1></path><path d="M16.244 18.21002a56.048 56.048 0 0 1 -8.1313 -0.8853599999999999 3.3480000000000003 3.3480000000000003 0 0 1 -2.3374 -4.7802C6.500699999999999 11.097999999999999 16.04994 3.35854 21.79548 1.2059a1.14328 1.14328 0 0 1 1.36772 1.68392c-1.2183 1.8599999999999999 -3.5340000000000003 4.0641 -7.88702 8.56716 1.98772 0.124 4.207319999999999 -0.093 6.55216 -0.07688a3.66172 3.66172 0 0 1 3.0534999999999997 1.3813600000000001c0.6975 0.9734 0.97898 2.33058 0.32674000000000003 3.3356 -1.54504 2.37894 -9.10284 9.4054 -13.52468 12.80362 -1.5741800000000001 1.2096200000000001 -2.7565199999999996 1.27596 -3.41 0.26226 -0.39742 -0.6169 0.18166 -1.32618 0.5251399999999999 -1.8258999999999999C10.185979999999999 25.320800000000002 16.182000000000002 18.20754 16.244 18.21002z" fill=none stroke=#45413c stroke-linecap=round stroke-linejoin=round stroke-width=1></path></svg> Zero to Hero </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=/about title=About> <span>About</span> </a><li><a href=/archive title=Archive> <span>Archive</span> </a><li><a href=/tags title=Tags> <span>Tags</span> </a><li><a title="Geyik TV" href=https://zerotohero.tv> <span>Geyik TV</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a title="Vadideki Geyik" href=https://vadidekigeyik.com> <span>Vadideki Geyik</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a href=https://discord.gg/kampus title=kamp.us> <span>kamp.us</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a href=https://github.com/spiffe/spike title=SPIKE> <span>SPIKE</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a href=https://github.com/vmware-tanzu/secrets-manager title=VSecM> <span>VSecM</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zerotohero.dev>Home</a> »  <a href=https://zerotohero.dev/>Posts</a> »  <a href=https://zerotohero.dev/tips/mastodon-101/>Who Else Wants to Have Their Own Mastodon Server?</a></div><h1 class=post-title>Who Else Wants to Have Their Own Mastodon Server?</h1><div class=post-meta><span title="2023-05-27 00:00:00 +0000">2023-05-27</span> · 18 min · Volkan Özçelik</div></header><div class=toc><details><summary title="(Alt + C)" accesskey=c><span class=details>Table of Contents</span></summary> <div class=inner><ul><li><a aria-label=Introduction href=#introduction>Introduction</a><li><a aria-label="What Is a Mastodon Instance?" href=#what-is-a-mastodon-instance>What Is a Mastodon Instance?</a><li><a aria-label="Why Would You Want Your Own Instance?" href=#why-would-you-want-your-own-instance>Why Would You Want Your Own Instance?</a><li><a aria-label="The Infra" href=#the-infra>The Infra</a><li><a aria-label="Server Version" href=#server-version>Server Version</a><li><a aria-label="Compute and Memory Requirements" href=#compute-and-memory-requirements>Compute and Memory Requirements</a><li><a aria-label="Securing The Machine" href=#securing-the-machine>Securing The Machine</a><li><a aria-label="Firewall Rules" href=#firewall-rules>Firewall Rules</a><li><a aria-label="DNS Settings" href=#dns-settings>DNS Settings</a><li><a aria-label="CloudFront Setup" href=#cloudfront-setup>CloudFront Setup</a><li><a aria-label="S3 Bucket Settings" href=#s3-bucket-settings>S3 Bucket Settings</a><li><a aria-label="Setting Up Mastodon The Hard Way" href=#setting-up-mastodon-the-hard-way>Setting Up Mastodon The Hard Way</a><li><a aria-label="You’ll Need An Older Version of yarn" href=#you-ll-need-an-older-version-of-yarn>You’ll Need An Older Version of yarn</a><li><a aria-label="Install node and npm" href=#install-node-and-npm>Install node and npm</a><li><a aria-label="Create an Unprivileged mastodon User" href=#create-an-unprivileged-mastodon-user>Create an Unprivileged mastodon User</a><li><a aria-label="Configure npm to Work Without Root Privileges" href=#configure-npm-to-work-without-root-privileges>Configure npm to Work Without Root Privileges</a><li><a aria-label="Patch yarn" href=#patch-yarn>Patch yarn</a><li><a aria-label="Install Postgres" href=#install-postgres>Install Postgres</a><li><a aria-label="Install Ruby" href=#install-ruby>Install Ruby</a><li><a aria-label="Configure Postgres" href=#configure-postgres>Configure Postgres</a><li><a aria-label="Set Up Mastodon" href=#set-up-mastodon>Set Up Mastodon</a><li><a aria-label="Getting TLS Certificates" href=#getting-tls-certificates>Getting TLS Certificates</a><li><a aria-label="Configure NGINX" href=#configure-nginx>Configure NGINX</a><li><a aria-label="Set Up NGINX to Use mastodon User" href=#set-up-nginx-to-use-mastodon-user>Set Up NGINX to Use mastodon User</a><li><a aria-label="Link the Site" href=#link-the-site>Link the Site</a><li><a aria-label="Start NGINX" href=#start-nginx>Start NGINX</a><li><a aria-label="Setting Up systemd Services" href=#setting-up-systemd-services>Setting Up systemd Services</a> <ul><li><a aria-label=/etc/systemd/system/mastodon-sideqik.service href=#etc-systemd-system-mastodon-sideqik-service>/etc/systemd/system/mastodon-sideqik.service</a><li><a aria-label=/etc/systemd/system/mastodon-streaming.service href=#etc-systemd-system-mastodon-streaming-service>/etc/systemd/system/mastodon-streaming.service</a><li><a aria-label=/etc/systemd/system/mastodon-web.service href=#etc-systemd-system-mastodon-web-service>/etc/systemd/system/mastodon-web.service</a></ul><li><a aria-label="Checking The Services" href=#checking-the-services>Checking The Services</a><li><a aria-label="Securing Mastodon" href=#securing-mastodon>Securing Mastodon</a><li><a aria-label="Scaling Up Mastodon" href=#scaling-up-mastodon>Scaling Up Mastodon</a><li><a aria-label="Monitoring and Operating Mastodon" href=#monitoring-and-operating-mastodon>Monitoring and Operating Mastodon</a><li><a aria-label=Conclusion href=#conclusion>Conclusion</a><li><a aria-label="Section Contents" href=#section-contents>Section Contents</a></ul></div></details></div><div class=post-content><div class=z2h-image><p class=img><img alt=Uliphant. src=/images/size/w1200/2024/03/eli.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Uliphant.</div><h2 id=introduction>Introduction</h2><blockquote><p><strong>Update</strong> (2024-03-05)<p><a href=https://twitter.com/vadidekivolkan>I am back on Twitter</a> . I still think Elon is a terrible human being and he does not know jack shit about what he’s doing; however, Twitter is still the best way to represent the communities I represent, and spread the word around when needed. I have other reasons to be back, which I’ll try to expand in this sidenote a bit.<p>For starters, when you see everyone who despises Elon, still continue tweeting, it does not make sense to shield you away. I tried that for at least six months. For <strong>six freaking months</strong>, I was only at Mastodon, not even glancing at Twitter. But when I checked back, I realized every single person who was against Elon was still on the platform.<p>If we don’t move as a community, my individual resistance is just futile, and even counterproductive. So, I’m still on the platform. Yes, Twitter is a racist, sexist, misogynistic, hatred-fulled dumspster fire; however, no alternative platform has been strong enough to force it to extinction. For whatever reason, it’s still around.<p>The current Twitter is like a democracy ran by a tyrant. People are (<em>still</em>) there, because no matter how much it sucks, it is the only platform that helps them connect to the world at scale. When you run away, you isolate yourself.<p>Social isolation is the opposite of social media: Nobody wants that.<p>So, as long as there is no significant competitor to take its place, this hell hole of a birdsite will continue to exist. And I will be there being myself, not giving a flying clue to others.</blockquote><p>After <a href=https://www.washingtonpost.com/business/2022/11/09/elon-musk-how-not-to-fire-employees/>all</a> <a href=https://www.wired.com/story/twitter-users-mastodon-meltdown/>the</a> <a href=https://variety.com/2022/digital/news/mark-cuban-slams-elon-musk-twitter-verification-plan-nightmare-1235429190/>madness</a> that has been happening in the birdsite, I flipped the switch and <a href=http://hachyderm.io/@volkan>joined Mastodon (on Hachyderm, where all the misfits hang out)</a>.<p>With that, I have also wanted to create my own Mastodon instance for a while.<p>This article summarizes my experiences with the process and provides tips and tricks to those who wish to follow the same path.<blockquote><p><strong>This Article Applies to</strong> <strong>Mastodon v3.5.3</strong><p>The article here discusses my deployment experience for v3.5.3 of Mastodon. If you are deploying a different version, <a href=https://github.com/mastodon/mastodon>make sure to follow the official installation guides</a>.<p>I’ve recently upgraded to a much newer version, and the installation/upgrade experience was <strong>very</strong> smooth.</blockquote><h2 id=what-is-a-mastodon-instance>What Is a Mastodon Instance?</h2><blockquote><p><strong>Interested? Check Out Fedi.Tips</strong><p>For those new to the concept and want to learn more about <strong>Mastodon</strong> and the <strong>Fediverse</strong>, <a href=https://fedi.tips/>fedi.tips</a> is a great reference.</blockquote><p>To sum it up at a very high level, <strong>Fediverse</strong> is a collection of independently-run servers. You can create an account in any one of them and follow, like, comment, and otherwise interact with anyone else with thousands of other servers.<p>It’s like you have a passport tied to a single country. And with that passport, you can visit any country you like and interact with the people and culture. So that’s where the “<em>Fed</em>” of the <strong>Fediverse</strong> comes from: It is “<em>federated</em>.”<p>Though, if you are at a point to deploy your own Mastodon instance, you probably already know that 😀.<h2 id=why-would-you-want-your-own-instance>Why Would You Want Your Own Instance?</h2><blockquote><p><strong>Update 2024-05-27</strong><p>I stopped using my personal mastodon instance on <code>z2h.dev</code>; I have other plans for the domain. I’m still on Hachyderm, though.</blockquote><p>So, why would anyone want to create their own <strong>Mastodon</strong> instance?<p>The first thing is, with your instance, you have total control over the content and the community. If you are a <strong>content creator</strong> or someone with relatively high visibility, it makes perfect sense to have your own Mastodon instance and interact with people who want the hear what you have to say there.<p>With this approach, you manage your identity instead of letting your identity become an advertising opportunity for a billion-dollar corporation.<p>Secondly, use it as a <strong>microblog</strong>, where you gather your thoughts and share one-off ideas. If they are not that interesting to others, who cares 🤷‍♂️? It’s your instance, server, ideas, and rules. I use my instance to write down random <em>to-do</em> notes, share bookmarks to things I might not easily find later, and so on.<p>Or you can do it out of <strong>curiosity</strong>: To have fun exploring new technology, because you can 🙂. No matter your intention, if you want to create your instance, here is my recent experience.<blockquote><p><strong>z2h.dev is my Little Kingdom</strong><p>As of now, I’m running a single-person instance. Like, it’s only me on the server, sharing my random stuff. Yet, it’s public; so people still come and go and occasionally like and boost the content too.</blockquote><p>Having a single-person instance, my compute requirements are minimal. Keep in mind that as the number of users in your instance increase, so will your compute requirements.<p>Mastodon can be a beast to scale up, especially if your community is active, vibrant, and highly engaged. Which also is an excellent segue to the next section.<h2 id=the-infra>The Infra</h2><p>Here’s my current setup:<ul><li>A single dedicated <a href=https://www.linode.com/><strong>Linode</strong></a> server with 2 CPU cores and 4 GB of Memory.<li><a href=https://aws.amazon.com/pm/serv-s3/><strong>Amazon S3</strong></a> is the backing data store for static assets.<li><a href=https://aws.amazon.com/cloudfront/><strong>Amazon CloudFront</strong></a> as a CDN layer in front of <strong>S3</strong>.<li><a href=https://aws.amazon.com/certificate-manager/><strong>AWS Certificate Manager</strong></a> to manage TLS certificates for the static assets (files.z2h.dev).<li><a href=https://certbot.eff.org/><strong>Certbot</strong></a> to do the same for the content at z2h.dev.<li><strong>Linode DNS</strong>, to manage the DNS records on the Linode end.<li><strong>Linode Cloud Firewall</strong> because I want my box to be safe.<li><strong>Linode Backups</strong> because I don’t want to worry about losing data.<li><a href=https://www.mailgun.com/><strong>Mailgun</strong></a> as the SMTP server because using a local SMTP can be problematic, especially when/if I want to extend the server to a larger audience. You should follow <a href=https://documentation.mailgun.com/>Mailgun’s official documentation</a> for SMTP configuration.</ul><p>Here’s what my current server utilization looks like:<div class=z2h-image><p class=img><img alt="Linode server utilization." src=/images/2022/11/Screenshot-2022-11-12-at-7.48.38-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Linode server utilization.</div><p>It’s not much because there is not much going on. Yet, it also shows that the above specs are more than adequate to run your own Mastodon instance.<h2 id=server-version>Server Version</h2><p>I’m running an Ubuntu server (<em>which</em> <a href=https://docs.joinmastodon.org/admin/install/><em>Mastodon official docs</em></a> <em>recommend, too</em>) with the following version:<pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>Distributor ID:	Ubuntu
</span><span>Description:    Ubuntu 22.10
</span><span>Release:        22.10
</span><span>Codename:       kinetic
</span></code></pre><h2 id=compute-and-memory-requirements>Compute and Memory Requirements</h2><p>Regarding resource utilization, I’m coasting at <strong>1GB</strong> of ram and almost zero CPU (because only one person, me, is posting). So if you want to run a single-person instance, a VPS that gives you 2gigs of RAM and some minimal CPU would work for your needs.<p>Though, your compute, and memory requirements be <strong>much</strong> higher depending on the traffic and activity on your instance.<h2 id=securing-the-machine>Securing The Machine</h2><p>Since this is a <a href=https://www.linode.com/><strong>Linode</strong></a> box, I’ve followed Linode’ s security recommendations. I won’t detail them here because the way you secure your system will also depend on what you plan to use; however, you can follow the excellent documentation that Linode has on those topics:<ul><li><a href=https://www.linode.com/docs/guides/set-up-and-secure/>Setting Up and Securing a Compute Instance</a><li><a href=https://www.linode.com/docs/guides/using-fail2ban-to-secure-your-server-a-tutorial/>Using Fail2ban to Secure Your Server</a><li><a href=https://www.linode.com/docs/guides/set-up-web-server-host-website/>Set Up a Web Server and Host a Website</a></ul><h2 id=firewall-rules>Firewall Rules</h2><p>I don’t have that complicated of a firewall setup. Here is what it looks like:<div class=z2h-image><p class=img><img alt="Linode firewall rules." src=/images/2022/11/Screenshot-2022-11-12-at-8.00.11-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Linode firewall rules.</div><ul><li><strong>Inbound</strong> <ul><li>Allow inbound ssh to a single IP<li>Accept all inbound HTTP<li>Accept all inbound HTTPS<li>Deny everything else</ul><li><strong>Outbound</strong> <ul><li>Allow everything</ul></ul><p>Which is good enough for the purpose of this application.<h2 id=dns-settings>DNS Settings</h2><p>For the sake of completeness, I’ll share the DNS settings too. Here’s what it looks like:<div class=z2h-image><p class=img><img alt="SOA, NS, MX, A, AAAA" src=/images/2022/11/Screenshot-2022-11-12-at-8.03.45-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>SOA, NS, MX, A, AAAA</div><div class=z2h-image><p class=img><img alt="CNAME, TXT, SRV, CAA" src=/images/2022/11/Screenshot-2022-11-12-at-8.03.57-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>CNAME, TXT, SRV, CAA</div><p>The <strong>CNAME</strong> records are there for <a href=https://www.mailgun.com/><strong>Mailgun</strong></a> to be able to validate the domain; you can check its documentation for instructions about how to set it up.<p>Also, note that a <strong>CNAME</strong> record for files.z2h.dev points to an <a href=https://docs.aws.amazon.com/AmazonCloudFront><strong>Amazon CloudFront</strong></a> CDN; we’ll come to that soon.<p>The <strong>TXT</strong> records are for <a href=https://www.mailgun.com/blog/deliverability/spf-records-basics/>**Mailgun SPF Validation **</a> and for <a href=https://aws.amazon.com/certificate-manager/><strong>AWS Certificate Manager</strong></a> to issue and verify certificates to the static assets served at files.z2h.dev on an AWS S3 bucket.<h2 id=cloudfront-setup>CloudFront Setup</h2><p>The thing about <strong>Mastodon</strong> is it will store files. Lots of files. Images, memes, animated gifs, videos… they need to go somewhere. And the local disk of your machine is not the best place to put them.<p>In my current setup, I’m using an <strong>S3</strong> bucket backed up by <strong>CloudFront</strong> to sort that out.<p>Here are the <strong>CloudFront</strong> distribution settings for files.z2h.dev for reference:<div class=z2h-image><p class=img><img alt="CloudFront: Main Settings" src=/images/2022/11/Screenshot-2022-11-12-at-8.19.45-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>CloudFront: Main Settings</div><div class=z2h-image><p class=img><img alt="CloudFront: Origin Settings" src=/images/2022/11/Screenshot-2022-11-12-at-8.20.10-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>CloudFront: Origin Settings</div><div class=z2h-image><p class=img><img alt="CloudFront: Behaviors" src=/images/2022/11/Screenshot-2022-11-12-at-8.20.20-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>CloudFront: Behaviors</div><h2 id=s3-bucket-settings>S3 Bucket Settings</h2><p>The <strong>CloudFront</strong> uses an <strong>S3 Bucket</strong> as its origin. Here are the details of the bucket.<p>I have set up a <strong>bucket policy</strong> to publicly allow GET operations on the bucket.<pre class=language-json data-lang=json style=color:#fdf4c1aa;background-color:#282828><code class=language-json data-lang=json><span>{
</span><span>    </span><span style=color:#b8bb26>"Version"</span><span>: </span><span style=color:#b8bb26>"2012-10-17"</span><span>,
</span><span>    </span><span style=color:#b8bb26>"Statement"</span><span>: [
</span><span>        {
</span><span>            </span><span style=color:#b8bb26>"Sid"</span><span>: </span><span style=color:#b8bb26>"Allow Public Access to All Objects"</span><span>,
</span><span>            </span><span style=color:#b8bb26>"Effect"</span><span>: </span><span style=color:#b8bb26>"Allow"</span><span>,
</span><span>            </span><span style=color:#b8bb26>"Principal"</span><span>: </span><span style=color:#b8bb26>"*"</span><span>,
</span><span>            </span><span style=color:#b8bb26>"Action"</span><span>: </span><span style=color:#b8bb26>"s3:GetObject"</span><span>,
</span><span>            </span><span style=color:#b8bb26>"Resource"</span><span>: </span><span style=color:#b8bb26>"arn:aws:s3:::files.z2h.dev/*"
</span><span>        }
</span><span>    ]
</span><span>}
</span></code></pre><p>I also had to <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/acl-overview.html><strong>enable access control lists</strong></a> on the bucket for my <strong>Mastodon</strong> instance to push stuff to it without raising errors. So here’s how that part looks on the console:<div class=z2h-image><p class=img><img alt="Bucket ACL Rules" src=/images/2022/11/Screenshot-2022-11-12-at-8.44.55-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Bucket ACL Rules</div><p>Without these ACL rules, Mastodon could not upload files to the bucket.<p>Other than that, everything on the bucket is in its default settings.<h2 id=setting-up-mastodon-the-hard-way>Setting Up Mastodon The Hard Way</h2><p>Now, we come to the fun part. You can install <strong>Mastodon</strong><ul><li>As a set of <strong>Docker</strong> containers (using docker-compose).<li>As a <strong>Kubernetes</strong> deployment.<li>Or as a bare-metal installation directly on your server.</ul><p>I tried the <strong>Docker</strong> installation route but could not make it work. It might be because I was using an RC version instead of a stable one, or maybe because I missed a step during the installation; however, I had better luck with the bare-metal installation, so I’ll explain that in this article.<p>Besides, a bare-metal install will give you the best performance benefit compared to the alternatives.<p>So there are no helm templates, no Docker compose files… We’re gonna do this <strong>the hard way</strong> (<a href=https://github.com/kelseyhightower/kubernetes-the-hard-way><em>Kelsey</em></a>, anyone?)<h2 id=you-ll-need-an-older-version-of-yarn>You’ll Need An Older Version of <code>yarn</code></h2><p>One of the most significant issues you are likely going to face <a href=https://docs.joinmastodon.org/admin/install/>is if you follow the official docs</a>. As of the time of this writing (<em>late 2022</em>), the docs’ instruction on installing <code>node</code> and <code>yarn</code> is inadequate and incomplete, and if you follow them step-by-step, you’ll likely fail while bundling the static assets.<p>The gist is:<ul><li>You need an <strong>older</strong> version of <code>yarn</code> (<strong><em>v1.x</em></strong>) to bundle static assets.<li>However, you need <strong>the most recent</strong> <code>node</code> version for security and stability.</ul><p>I was able to do that by…<ul><li>Installing the recent versions of <code>node</code> and yarn on the system,<li>And then patching the <code>yarn</code> binaries <a href=https://github.com/yarnpkg/yarn/releases/tag/v1.22.19>with the most recent v1.x release that I could find</a>.</ul><p>The following sections outline how I managed to do that.<h2 id=install-node-and-npm>Install <code>node</code> and <code>npm</code></h2><p>First, install the recent version of <code>node</code> and <code>npm</code>:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo apt install curl wget gnupg apt-transport-https \
</span><span style=color:#fdf4c1>lsb-release ca-certificates
</span><span>
</span><span style=color:#928374;font-style:italic># Install node.
</span><span style=color:#928374;font-style:italic># You can also try a newer version of Node.
</span><span style=color:#928374;font-style:italic># I'm using v18.x as of now.
</span><span style=color:#fdf4c1>curl -sL https://deb.nodesource.com/setup_18.x </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>bash -
</span><span>
</span><span style=color:#928374;font-style:italic># Check node and npm versions.
</span><span>
</span><span style=color:#fdf4c1>node -v
</span><span style=color:#928374;font-style:italic># v18.7.0
</span><span>
</span><span style=color:#fdf4c1>npm -v
</span><span style=color:#928374;font-style:italic># 6.14.17
</span></code></pre><blockquote><p><strong>You Might Want to Use <code>nvm</code></strong><p>Note that you might want to use <a href=https://github.com/nvm-sh/nvm><code>nvm</code> (<em>Node Version Manager</em>)</a><br> to switch between different versions of <code>node</code>. That might be helpful if your Mastodon instance does not function<br> properly using a particular version of <code>node</code>.</blockquote><h2 id=create-an-unprivileged-mastodon-user>Create an Unprivileged <code>mastodon</code> User</h2><p>The next thing is to create a dedicated user to run <strong>Mastodon</strong>. This is <strong>recommended</strong> because Mastodon is a <a href=https://www.ruby-lang.org/en/>ruby</a> monolith, and switching to different user accounts is a hassle-free way to experiment with different Ruby versions.<p>Besides, having a dedicated, unprivileged user is a good security practice.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#928374;font-style:italic># Add a `mastodon` user, if you haven't already done so
</span><span style=color:#fdf4c1>adduser --disabled-login mastodon
</span><span style=color:#928374;font-style:italic># Set a password for the user:
</span><span style=color:#fdf4c1>sudo passwd mastodon
</span><span style=color:#928374;font-style:italic># Switch to that user:
</span><span style=color:#fdf4c1>sudo su - mastodon
</span><span>
</span><span style=color:#928374;font-style:italic># Validate that we are on the correct user account:
</span><span style=color:#fdf4c1>whoami
</span><span style=color:#928374;font-style:italic># mastodon
</span></code></pre><h2 id=configure-npm-to-work-without-root-privileges>Configure <code>npm</code> to Work Without Root Privileges</h2><p>Next, we’ll configure <code>npm</code> to work rootless because we are not allowed to do <code>sudo</code> for the <code>mastodon</code> user.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo su - mastodon
</span><span>
</span><span style=color:#fdf4c1>mkdir ~/.npm-global
</span><span style=color:#fdf4c1>npm config set prefix </span><span style=color:#b8bb26>'~/.npm-global'
</span><span>
</span><span style=color:#928374;font-style:italic># Update ~/.profile with this:
</span><span style=color:#928374;font-style:italic># export PATH=~/.npm-global/bin:$PATH
</span><span>
</span><span style=color:#928374;font-style:italic># Then source it to use the new $PATH:
</span><span style=color:#fabd2f>source </span><span style=color:#fdf4c1>~/.profile
</span></code></pre><h2 id=patch-yarn>Patch <code>yarn</code></h2><p><strong>This is the critical part</strong>. You’ll need to use the <code>**v1.x**</code> version of <code>yarn</code> (<em>at least when this article is written, that’s the case</em>). If you install <code>yarn</code> following the documentation, you’ll get a much higher version, which will cause errors when bundling static asses for the web application.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo su - mastodon
</span><span>
</span><span style=color:#fdf4c1>wget https://github.com/yarnpkg/yarn/releases/\
</span><span style=color:#fdf4c1>download/v1.22.19/yarn-v1.22.19.tar.gz
</span><span>
</span><span style=color:#fdf4c1>tar -xzvf yarn-v1.22.19.tar.gz 
</span><span>
</span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> yarn-v1.22.19/
</span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> bin/
</span><span style=color:#fdf4c1>cp yarn /home/mastodon/.npm-global/bin/
</span><span style=color:#fdf4c1>cp yarnpkg /home/mastodon/.npm-global/bin/
</span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> ..
</span><span style=color:#fdf4c1>cp bin/</span><span style=color:#fe8019>*</span><span style=color:#fdf4c1> /home/mastodon/.npm-global/bin
</span></code></pre><p>That will hopefully take care of your possible <code>yarn</code> problems. If not, you can find yourself experimenting with things a bit. Honestly, this version incompatibility was the most challenging part. That took <strong>hours</strong> for me to fix. I’m sharing it here so that others don’t suffer the same pains I’ve had.<h2 id=install-postgres>Install Postgres</h2><p>Mastodon uses Postgres (<em>or any Postgres-compatible DB</em>) as its backend database. So, we’ll install that to our instance too.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo su
</span><span>
</span><span style=color:#fdf4c1>wget -O /usr/share/keyrings/postgresql.asc \</span><span style=color:#fdf4c1;background-color:#932b1e> </span><span style=color:#fdf4c1>
</span><span style=color:#fdf4c1>https://www.postgresql.org/media/keys/ACCC4CF8.asc
</span><span>
</span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>"deb [signed-by=/usr/share/keyrings/postgresql.asc] \
</span><span style=color:#b8bb26>http://apt.postgresql.org/pub/repos/apt \
</span><span style=color:#b8bb26>$(</span><span style=color:#fdf4c1>lsb_release -cs</span><span style=color:#b8bb26>)-pgdg main" </span><span style=color:#fdf4c1>\
</span><span style=color:#fe8019>></span><span style=color:#fdf4c1> /etc/apt/sources.list.d/postgresql.list
</span><span>
</span><span style=color:#fdf4c1>apt update
</span><span>
</span><span style=color:#fdf4c1>apt install -y \
</span><span style=color:#fdf4c1>  imagemagick ffmpeg libpq-dev libxml2-dev libxslt1-dev \
</span><span style=color:#fdf4c1>  file git-core g++ libprotobuf-dev protobuf-compiler \
</span><span style=color:#fdf4c1>  pkg-config nodejs gcc autoconf \
</span><span style=color:#fdf4c1>  bison build-essential libssl-dev libyaml-dev libreadline6-dev \
</span><span style=color:#fdf4c1>  zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev \
</span><span style=color:#fdf4c1>  nginx redis-server redis-tools postgresql postgresql-contrib \
</span><span style=color:#fdf4c1>  certbot python3-certbot-nginx libidn11-dev libicu-dev \
</span><span style=color:#fdf4c1>  libjemalloc-dev
</span></code></pre><h2 id=install-ruby>Install Ruby</h2><p>Mastodon is a <a href=https://ruby-lang.org/>Ruby</a> server, so we’ll, for sure, need <code>ruby</code>.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>su - mastodon
</span><span>
</span><span style=color:#fdf4c1>git clone https://github.com/rbenv/rbenv.git ~/.rbenv
</span><span style=color:#fabd2f>cd </span><span style=color:#fdf4c1>~/.rbenv </span><span style=color:#fe8019>&& </span><span style=color:#fdf4c1>src/configure </span><span style=color:#fe8019>&& </span><span style=color:#fdf4c1>make -C src
</span><span>
</span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>'export PATH="$HOME/.rbenv/bin:$PATH"' </span><span style=color:#fe8019>>> </span><span style=color:#fdf4c1>~/.bashrc
</span><span style=color:#fabd2f>echo </span><span style=color:#b8bb26>'eval "$(rbenv init -)"' </span><span style=color:#fe8019>>> </span><span style=color:#fdf4c1>~/.bashrc
</span><span>
</span><span style=color:#fabd2f>exec</span><span style=color:#fdf4c1> bash
</span><span>
</span><span style=color:#fdf4c1>git clone https://github.com/rbenv/ruby-build.git \
</span><span style=color:#fdf4c1>~/.rbenv/plugins/ruby-build
</span></code></pre><p>Once that’s done, install the <code>ruby</code> version that we need:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>RUBY_CONFIGURE_OPTS</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>--with-jemalloc </span><span style=color:#fdf4c1>rbenv install 3.0.3
</span><span style=color:#fdf4c1>rbenv global 3.0.3
</span></code></pre><p>We’ll also need <code>bundler</code>:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>gem install bundler --no-document
</span></code></pre><h2 id=configure-postgres>Configure Postgres</h2><p>Next up, we’ll configure our database:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo -u postgres psql
</span><span>
</span><span style=color:#fdf4c1>CREATE USER mastodon CREATEDB</span><span style=color:#fe8019>;
</span><span style=color:#b8bb26>\q
</span></code></pre><p>And, that’s it 🙌.<h2 id=set-up-mastodon>Set Up Mastodon</h2><p>Now it’s time to set up the elephant in the room.<p>We’ll build <strong>Mastodon</strong> straight from the source code.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>git clone https://github.com/tootsuite/mastodon.git \
</span><span style=color:#fdf4c1>live </span><span style=color:#fe8019>&& </span><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> live
</span><span style=color:#fdf4c1>git checkout \
</span><span style=color:#fdf4c1>$(git tag -l </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>grep -v </span><span style=color:#b8bb26>'rc[0-9]*$' </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>sort -V </span><span style=color:#fe8019>| </span><span style=color:#fdf4c1>tail -n 1)
</span><span>
</span><span style=color:#fdf4c1>bundle config deployment </span><span style=color:#b8bb26>'true'
</span><span style=color:#fdf4c1>bundle config without </span><span style=color:#b8bb26>'development test'
</span><span style=color:#fdf4c1>bundle install -j$(getconf _NPROCESSORS_ONLN)
</span><span style=color:#fdf4c1>yarn install --pure-lockfile
</span></code></pre><p>After all these set, we’ll run the interactive setup wizard:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>RAILS_ENV</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>production </span><span style=color:#fdf4c1>bundle exec rake mastodon:setup
</span></code></pre><p>The wizard will ask you certain questions. I’ve added my answers to some of those, redacting sensitive parts.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>LOCAL_DOMAIN</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>z2h.dev
</span><span style=color:#fdf4c1>SINGLE_USER_MODE</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>false
</span><span style=color:#fdf4c1>DB_HOST</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>/var/run/postgresql
</span><span style=color:#fdf4c1>DB_PORT</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>5432
</span><span style=color:#fdf4c1>DB_NAME</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>mastodon_production
</span><span style=color:#fdf4c1>DB_USER</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>mastodon
</span><span style=color:#fdf4c1>DB_PASS</span><span style=color:#fe8019>=
</span><span style=color:#fdf4c1>REDIS_HOST</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>localhost
</span><span style=color:#fdf4c1>REDIS_PORT</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>6379
</span><span style=color:#fdf4c1>REDIS_PASSWORD</span><span style=color:#fe8019>=
</span><span style=color:#fdf4c1>S3_ENABLED</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>true
</span><span style=color:#fdf4c1>S3_PROTOCOL</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>https
</span><span style=color:#fdf4c1>S3_BUCKET</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>files.z2h.dev
</span><span style=color:#fdf4c1>S3_REGION</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>us-west-2
</span><span style=color:#fdf4c1>S3_HOSTNAME</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>s3.us-west-2.amazonaws.com
</span><span style=color:#fdf4c1>AWS_ACCESS_KEY_ID</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>AKIA</span><span style=color:#fa5c4b>[</span><span style=color:#b8bb26>REDACTED</span><span style=color:#fa5c4b>]
</span><span style=color:#fdf4c1>AWS_SECRET_ACCESS_KEY</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>Yj</span><span style=color:#fa5c4b>[</span><span style=color:#b8bb26>REDACTED</span><span style=color:#fa5c4b>]
</span><span style=color:#fdf4c1>S3_ALIAS_HOST</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>files.z2h.dev
</span><span style=color:#fdf4c1>SMTP_SERVER</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>smtp.mailgun.org
</span><span style=color:#fdf4c1>SMTP_PORT</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>587
</span><span style=color:#fdf4c1>SMTP_LOGIN</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>postmaster@z2h.dev
</span><span style=color:#fdf4c1>SMTP_PASSWORD</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>b</span><span style=color:#fa5c4b>[</span><span style=color:#b8bb26>REDACTED</span><span style=color:#fa5c4b>]
</span><span style=color:#fdf4c1>SMTP_AUTH_METHOD</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>plain
</span><span style=color:#fdf4c1>SMTP_OPENSSL_VERIFY_MODE</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>none
</span><span style=color:#fdf4c1>SMTP_FROM_ADDRESS</span><span style=color:#fe8019>=</span><span style=color:#b8bb26>'Mastodon &lt;notifications@z2h.dev>'
</span></code></pre><p>Once the installer finishes successfully, you’ll get a prompt similar to this:<pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>All done! You can now power on the Mastodon server 🐘
</span><span>
</span><span>Do you want to create an admin user straight away? Yes
</span><span>Username: $usernameYouChoseDuringSetup
</span><span>E-mail: $emailYouChoseDuringSetup
</span><span>You can login with the password: $someRandomPassword
</span><span>You can change your password once you login.
</span></code></pre><blockquote><p><strong>The Installer Gave Me an <code>emoji-mart</code>-Related Error</strong><p>Before triggering the setup, I also had to manually<br> <code>npm install --save emoji-mart</code> in the <code>live</code> folder<br> because the installer complained otherwise.<p>I don’t know if it will be fixed by the time you use the latest and<br> greatest Mastodon. Yet, I wanted to share it here in case you<br> bump into a similar issue.</blockquote><h2 id=getting-tls-certificates>Getting TLS Certificates</h2><p>Once you have your compute instance, DNS, and ingress firewall set up, you can fetch a TLS certificate from <a href=https://letsencrypt.org/>Let’s Encrypt</a> using <a href=https://certbot.eff.org/><code>certbot</code></a>:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo certbot certonly --standalone -d z2h.dev
</span></code></pre><p>The command above will temporarily spin up a web server, do the necessary negotiations and fetch a TLS certificate for the domain <code>z2h.dev</code>.<p>Also, ensure that certbot timer is enabled via <code>systemctl status certbot.timer</code>. If the timer is not enabled, make sure to enable it using <code>systemctl enable certbot.timer</code>.<pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>volkan@z2h-dev:~$ systemctl status certbot.timer
</span><span>● certbot.timer - Run certbot twice daily
</span><span>     Loaded: loaded (/lib/systemd/system/certbot.timer; 
</span><span>enabled; preset: enabled)
</span><span>     Active: active (waiting) 
</span><span>since Fri 2022-11-11 03:02:18 PST; 1 day 9h ago
</span><span>      Until: Fri 2022-11-11 03:02:18 PST; 1 day 9h ago
</span><span>    Trigger: Sat 2022-11-12 22:37:01 PST; 10h left
</span><span>   Triggers: ● certbot.service
</span></code></pre><p>Also, make sure that your certificates are where they need to be:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo ls -al /etc/letsencrypt/live/z2h.dev
</span><span>
</span><span style=color:#928374;font-style:italic># The output should look something like this:
</span><span style=color:#928374;font-style:italic># drwxr-xr-x 2 root root 4096 Nov 11 02:41 .
</span><span style=color:#928374;font-style:italic># drwx------ 3 root root 4096 Nov 11 02:41 ..
</span><span style=color:#928374;font-style:italic># lrwxrwxrwx 1 root root   31 Nov 11 02:41 cert.pem 
</span><span style=color:#928374;font-style:italic># -> ../../archive/z2h.dev/cert1.pem
</span><span style=color:#928374;font-style:italic># lrwxrwxrwx 1 root root   32 Nov 11 02:41 chain.pem 
</span><span style=color:#928374;font-style:italic># -> ../../archive/z2h.dev/chain1.pem
</span><span style=color:#928374;font-style:italic># lrwxrwxrwx 1 root root   36 Nov 11 02:41 
</span><span style=color:#928374;font-style:italic># fullchain.pem -> ../../archive/z2h.dev/fullchain1.pem
</span><span style=color:#928374;font-style:italic># lrwxrwxrwx 1 root root   34 Nov 11 02:41 privkey.pem 
</span><span style=color:#928374;font-style:italic># -> ../../archive/z2h.dev/privkey1.pem
</span><span style=color:#928374;font-style:italic># -rw-r--r-- 1 root root  692 Nov 11 02:41 README
</span></code></pre><h2 id=configure-nginx>Configure NGINX</h2><p>Now that we have our certificates in place, we can configure <strong>NGINX</strong>.<p>Here’s my <code>/etc/nginx/sites-available/z2h.dev.conf</code><pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>map $http_upgrade $connection_upgrade {
</span><span>  default upgrade;
</span><span>  ''      close;
</span><span>}
</span><span>
</span><span>upstream backend {
</span><span>    server 127.0.0.1:3000 fail_timeout=0;
</span><span>}
</span><span>
</span><span>upstream streaming {
</span><span>    server 127.0.0.1:4000 fail_timeout=0;
</span><span>}
</span><span>
</span><span>proxy_cache_path /var/cache/nginx levels=1:2 
</span><span>  keys_zone=CACHE:10m inactive=7d max_size=1g;
</span><span>
</span><span>server {
</span><span>  listen 80;
</span><span>  listen [::]:80;
</span><span>  server_name z2h.dev;
</span><span>  root /home/mastodon/live/public;
</span><span>  location /.well-known/acme-challenge/ { allow all; }
</span><span>  location / { return 301 https://$host$request_uri; }
</span><span>}
</span><span>
</span><span>server {
</span><span>  listen 443 ssl http2;
</span><span>  listen [::]:443 ssl http2;
</span><span>  server_name z2h.dev;
</span><span>
</span><span>  ssl_protocols TLSv1.2 TLSv1.3;
</span><span>  ssl_ciphers HIGH:!MEDIUM:!LOW:!aNULL:!NULL:!SHA;
</span><span>  ssl_prefer_server_ciphers on;
</span><span>  ssl_session_cache shared:SSL:10m;
</span><span>  ssl_session_tickets off;
</span><span>
</span><span>  # Uncomment these lines once you acquire a certificate:
</span><span>  ssl_certificate     /etc/letsencrypt/live/z2h.dev/fullchain.pem;
</span><span>  ssl_certificate_key /etc/letsencrypt/live/z2h.dev/privkey.pem;
</span><span>
</span><span>  keepalive_timeout    70;
</span><span>  sendfile             on;
</span><span>  client_max_body_size 80m;
</span><span>
</span><span>  root /home/mastodon/live/public;
</span><span>
</span><span>  gzip on;
</span><span>  gzip_disable "msie6";
</span><span>  gzip_vary on;
</span><span>  gzip_proxied any;
</span><span>  gzip_comp_level 6;
</span><span>  gzip_buffers 16 8k;
</span><span>  gzip_http_version 1.1;
</span><span>  gzip_types text/plain text/css application/json 
</span><span>    application/javascript text/xml application/xml 
</span><span>    application/xml+rss text/javascript 
</span><span>    image/svg+xml image/x-icon;
</span><span>
</span><span>  location / {
</span><span>    try_files $uri @proxy;
</span><span>  }
</span><span>
</span><span>  location = /sw.js {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=604800, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/assets/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/avatars/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/emoji/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/headers/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/packs/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/shortcuts/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/sounds/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, must-revalidate";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ~ ^/system/ {
</span><span>    add_header Cache-Control 
</span><span>      "public, max-age=2419200, immutable";
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>    try_files $uri =404;
</span><span>  }
</span><span>
</span><span>  location ^~ /api/v1/streaming {
</span><span>    proxy_set_header Host $host;
</span><span>    proxy_set_header X-Real-IP $remote_addr;
</span><span>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span>    proxy_set_header X-Forwarded-Proto $scheme;
</span><span>    proxy_set_header Proxy "";
</span><span>
</span><span>    proxy_pass http://streaming;
</span><span>    proxy_buffering off;
</span><span>    proxy_redirect off;
</span><span>    proxy_http_version 1.1;
</span><span>    proxy_set_header Upgrade $http_upgrade;
</span><span>    proxy_set_header Connection $connection_upgrade;
</span><span>
</span><span>    add_header Strict-Transport-Security 
</span><span>      "max-age=63072000; includeSubDomains";
</span><span>
</span><span>    tcp_nodelay on;
</span><span>  }
</span><span>
</span><span>  location @proxy {
</span><span>    proxy_set_header Host $host;
</span><span>    proxy_set_header X-Real-IP $remote_addr;
</span><span>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span>    proxy_set_header X-Forwarded-Proto $scheme;
</span><span>    proxy_set_header Proxy "";
</span><span>    proxy_pass_header Server;
</span><span>
</span><span>    proxy_pass http://backend;
</span><span>    proxy_buffering on;
</span><span>    proxy_redirect off;
</span><span>    proxy_http_version 1.1;
</span><span>    proxy_set_header Upgrade $http_upgrade;
</span><span>    proxy_set_header Connection $connection_upgrade;
</span><span>
</span><span>    proxy_cache CACHE;
</span><span>    proxy_cache_valid 200 7d;
</span><span>    proxy_cache_valid 410 24h;
</span><span>    proxy_cache_use_stale error timeout 
</span><span>      updating http_500 http_502 http_503 http_504;
</span><span>    add_header X-Cached $upstream_cache_status;
</span><span>
</span><span>    tcp_nodelay on;
</span><span>  }
</span><span>
</span><span>  error_page 404 500 501 502 503 504 /500.html;
</span><span>}
</span></code></pre><p>I’ve copied the file <a href=https://github.com/mastodon/mastodon/blob/main/dist/nginx.conf>from Mastodon’s source code repo</a> and changed <code>example.com</code> to <code>z2h.dev</code> in the file.<h2 id=set-up-nginx-to-use-mastodon-user>Set Up NGINX to Use <code>mastodon</code> User</h2><p>One more thing, <code>nginx</code>, by default, uses <code>www-data</code> as a user, and that—in my case—caused issues when I started Mastodon’s microservices. Editing <code>/etc/nginx/nginx.conf</code> and replacing <code>www-data</code> with <code>mastodon</code> fixed that for me.<p>Here’s the entire file for reference:<pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>user mastodon;
</span><span>#user www-data;
</span><span>worker_processes auto;
</span><span>pid /run/nginx.pid;
</span><span>include /etc/nginx/modules-enabled/*.conf;
</span><span>
</span><span>events {
</span><span>    worker_connections 768;
</span><span>}
</span><span>
</span><span>http {
</span><span>    sendfile on;
</span><span>    tcp_nopush on;
</span><span>    types_hash_max_size 2048;
</span><span>
</span><span>    include /etc/nginx/mime.types;
</span><span>    default_type application/octet-stream;
</span><span>
</span><span>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
</span><span>    ssl_prefer_server_ciphers on;
</span><span>
</span><span>    access_log /var/log/nginx/access.log;
</span><span>    error_log /var/log/nginx/error.log;
</span><span>
</span><span>    gzip on;
</span><span>
</span><span>    include /etc/nginx/conf.d/*.conf;
</span><span>    include /etc/nginx/sites-enabled/*;
</span><span>}
</span></code></pre><h2 id=link-the-site>Link the Site</h2><pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fabd2f>cd</span><span style=color:#fdf4c1> /etc/nginx/sites-enabled
</span><span style=color:#fdf4c1>sudo ln -s ../sites-available/z2h.dev.conf
</span></code></pre><p>This will make <strong>NGINX</strong> import and use the rules that we’ve defined in the former section.<h2 id=start-nginx>Start NGINX</h2><p>Then we can start <code>nginx</code>:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo systemctl restart nginx
</span></code></pre><p>Then check the status of the <code>nginx</code> service:<pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>volkan@z2h-dev:~$ sudo systemctl status nginx
</span><span>● nginx.service - 
</span><span>A high performance web server and a reverse proxy server
</span><span>     Loaded: loaded 
</span><span>(/lib/systemd/system/nginx.service; enabled; preset: enabled)
</span><span>     Active: active (running)
</span></code></pre><p>So far, all looking good 👌.<h2 id=setting-up-systemd-services>Setting Up <code>systemd</code> Services</h2><p>Make sure you have these files under <code>/etc/systemd/system</code>. Again, I’ve copied them <a href=https://github.com/mastodon/mastodon/tree/main/dist>from the official Mastodon repository</a>.<h3 id=etc-systemd-system-mastodon-sideqik-service><code>/etc/systemd/system/mastodon-sideqik.service</code></h3><pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>[Unit]
</span><span>Description=mastodon-sidekiq
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>Type=simple
</span><span>User=mastodon
</span><span>WorkingDirectory=/home/mastodon/live
</span><span>Environment="RAILS_ENV=production"
</span><span>Environment="DB_POOL=25"
</span><span>Environment="MALLOC_ARENA_MAX=2"
</span><span>Environment="LD_PRELOAD=libjemalloc.so"
</span><span>ExecStart=/home/mastodon/.rbenv/shims/bundle exec sidekiq -c 25
</span><span>TimeoutSec=15
</span><span>Restart=always
</span><span># Proc filesystem
</span><span>ProcSubset=pid
</span><span>ProtectProc=invisible
</span><span># Capabilities
</span><span>CapabilityBoundingSet=
</span><span># Security
</span><span>NoNewPrivileges=true
</span><span># Sandboxing
</span><span>ProtectSystem=strict
</span><span>PrivateTmp=true
</span><span>PrivateDevices=true
</span><span>PrivateUsers=true
</span><span>ProtectHostname=true
</span><span>ProtectKernelLogs=true
</span><span>ProtectKernelModules=true
</span><span>ProtectKernelTunables=true
</span><span>ProtectControlGroups=true
</span><span>RestrictAddressFamilies=AF_INET
</span><span>RestrictAddressFamilies=AF_INET6
</span><span>RestrictAddressFamilies=AF_NETLINK
</span><span>RestrictAddressFamilies=AF_UNIX
</span><span>RestrictNamespaces=true
</span><span>LockPersonality=true
</span><span>RestrictRealtime=true
</span><span>RestrictSUIDSGID=true
</span><span>RemoveIPC=true
</span><span>PrivateMounts=true
</span><span>ProtectClock=true
</span><span># System Call Filtering
</span><span>SystemCallArchitectures=native
</span><span>SystemCallFilter=~@cpu-emulation @debug 
</span><span>  @keyring @ipc @mount @obsolete @privileged @setuid
</span><span>SystemCallFilter=@chown
</span><span>SystemCallFilter=pipe
</span><span>SystemCallFilter=pipe2
</span><span>ReadWritePaths=/home/mastodon/live
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span></code></pre><h3 id=etc-systemd-system-mastodon-streaming-service><code>/etc/systemd/system/mastodon-streaming.service</code></h3><pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>[Unit]
</span><span>Description=mastodon-streaming
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>Type=simple
</span><span>User=mastodon
</span><span>WorkingDirectory=/home/mastodon/live
</span><span>Environment="NODE_ENV=production"
</span><span>Environment="PORT=4000"
</span><span>Environment="STREAMING_CLUSTER_NUM=1"
</span><span>ExecStart=/usr/bin/node ./streaming
</span><span>TimeoutSec=15
</span><span>Restart=always
</span><span># Proc filesystem
</span><span>ProcSubset=pid
</span><span>ProtectProc=invisible
</span><span># Capabilities
</span><span>CapabilityBoundingSet=
</span><span># Security
</span><span>NoNewPrivileges=true
</span><span># Sandboxing
</span><span>ProtectSystem=strict
</span><span>PrivateTmp=true
</span><span>PrivateDevices=true
</span><span>PrivateUsers=true
</span><span>ProtectHostname=true
</span><span>ProtectKernelLogs=true
</span><span>ProtectKernelModules=true
</span><span>ProtectKernelTunables=true
</span><span>ProtectControlGroups=true
</span><span>RestrictAddressFamilies=AF_INET
</span><span>RestrictAddressFamilies=AF_INET6
</span><span>RestrictAddressFamilies=AF_NETLINK
</span><span>RestrictAddressFamilies=AF_UNIX
</span><span>RestrictNamespaces=true
</span><span>LockPersonality=true
</span><span>RestrictRealtime=true
</span><span>RestrictSUIDSGID=true
</span><span>RemoveIPC=true
</span><span>PrivateMounts=true
</span><span>ProtectClock=true
</span><span># System Call Filtering
</span><span>SystemCallArchitectures=native
</span><span>SystemCallFilter=~@cpu-emulation @debug 
</span><span>  @keyring @ipc @memlock @mount @obsolete 
</span><span>  @privileged @resources @setuid
</span><span>SystemCallFilter=pipe
</span><span>SystemCallFilter=pipe2
</span><span>ReadWritePaths=/home/mastodon/live
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span></code></pre><h3 id=etc-systemd-system-mastodon-web-service><code>/etc/systemd/system/mastodon-web.service</code></h3><pre class=language-txt data-lang=txt style=color:#fdf4c1aa;background-color:#282828><code class=language-txt data-lang=txt><span>[Unit]
</span><span>Description=mastodon-web
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>Type=simple
</span><span>User=mastodon
</span><span>WorkingDirectory=/home/mastodon/live
</span><span>Environment="RAILS_ENV=production"
</span><span>Environment="PORT=3000"
</span><span>Environment="LD_PRELOAD=libjemalloc.so"
</span><span>ExecStart=/home/mastodon/.rbenv/shims/bundle exec \
</span><span>puma -C config/puma.rb
</span><span>ExecReload=/bin/kill -SIGUSR1 $MAINPID
</span><span>TimeoutSec=15
</span><span>Restart=always
</span><span># Proc filesystem
</span><span>ProcSubset=pid
</span><span>ProtectProc=invisible
</span><span># Capabilities
</span><span>CapabilityBoundingSet=
</span><span># Security
</span><span>NoNewPrivileges=true
</span><span># Sandboxing
</span><span>ProtectSystem=strict
</span><span>PrivateTmp=true
</span><span>PrivateDevices=true
</span><span>PrivateUsers=true
</span><span>ProtectHostname=true
</span><span>ProtectKernelLogs=true
</span><span>ProtectKernelModules=true
</span><span>ProtectKernelTunables=true
</span><span>ProtectControlGroups=true
</span><span>RestrictAddressFamilies=AF_INET
</span><span>RestrictAddressFamilies=AF_INET6
</span><span>RestrictAddressFamilies=AF_NETLINK
</span><span>RestrictAddressFamilies=AF_UNIX
</span><span>RestrictNamespaces=true
</span><span>LockPersonality=true
</span><span>RestrictRealtime=true
</span><span>RestrictSUIDSGID=true
</span><span>RemoveIPC=true
</span><span>PrivateMounts=true
</span><span>ProtectClock=true
</span><span># System Call Filtering
</span><span>SystemCallArchitectures=native
</span><span>SystemCallFilter=~@cpu-emulation @debug 
</span><span>  @keyring @ipc @mount @obsolete @privileged @setuid
</span><span>SystemCallFilter=@chown
</span><span>SystemCallFilter=pipe
</span><span>SystemCallFilter=pipe2
</span><span>ReadWritePaths=/home/mastodon/live
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span></code></pre><p>That handles the <code>systemd</code> part of things.<h2 id=checking-the-services>Checking The Services</h2><p>Make sure you have all the services are up<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo systemctl status mastodon-</span><span style=color:#fe8019>*
</span></code></pre><p>If any of the services are down or disabled, you can enable them:<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>sudo systemctl enable mastodon-web
</span><span style=color:#fdf4c1>sudo systemctl enable mastodon-sideqik
</span><span style=color:#fdf4c1>sudo systemctl enable mastodon-streaming
</span><span style=color:#fdf4c1>sudo systemctl start mastodon-web
</span><span style=color:#fdf4c1>sudo systemctl start mastodon-sideqik
</span><span style=color:#fdf4c1>sudo systemctl start mastodon-streaming
</span></code></pre><p>If you didn’t have any issues so far, you should have a running <strong>Mastodon</strong> instance that you can browse to the domain you set up (in my case it’s <code>z2h.dev</code>. Then, you can log in as an Administrator with a random password that the installer has provided you during the guided installation section you’ve followed above.<h2 id=securing-mastodon>Securing Mastodon</h2><p>Since we have <strong>Mastodon</strong> itself up and running, it’s time to secure the instance.<p>We’ll start with the users.<p>Ah, as soon as I created the instance, I made a second unprivileged user.<p>I use the root user only to administer the Mastodon server, and I use the unprivileged user <a href=http://z2h.dev/@volkan>z2h.dev/@volkan</a> to post things on the site.<p>The next thing you <strong>MUST</strong> do is to <a href=https://github.com/McKael/mastodon-documentation/blob/master/Using-Mastodon/2FA.md>enable 2FA for all users you control</a>. <strong>DO NOT</strong> defer this. <strong>Mastodon</strong> is getting quite popular, which also means it’s attracting many people with bad intentions. Due to a zero-day vulnerability, you would not want your server to become a spammers’ barbeque backyard. <strong>2FA</strong> is an added layer of security that makes it extra hard for attackers to impersonate you.<h2 id=scaling-up-mastodon>Scaling Up Mastodon</h2><p>All the services <strong>Mastodon</strong> relies upon (<em>i.e., Redis, Postgres, etc</em>.) can scale independently. Mastodon is, in itself, stateless. That means you can put several Mastodon servers behind a load balancer and point them to the same Postgres and Redis, which will take care of scalability for a long time.<p>Here’s a high-level outline of how that might look like:<div class=z2h-image><p class=img><img alt="Scaling Up Mastodon" src=/images/2022/11/mastodon-lb.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Scaling Up Mastodon</div><p>If things get even crazier, you’ll have to come up with solutions to the bottleneck you are facing. Like tuning Redis, adding read replicas; doing the same to Postgres; tuning <strong>NGINX</strong>, maybe backing <strong>NGINX</strong> with another cloud load balancer; sharding the data, geographically sharding the users… the list can go on.<p>However, if you have reached that scale, the thing has become your full-time job, and you probably have a team of intelligent engineers to sort out these problems with you 🙂. If not, then you don’t have to worry about future issues.<h2 id=monitoring-and-operating-mastodon>Monitoring and Operating Mastodon</h2><p><a href=https://sidekiq.org/>SideKiq</a> is the Ruby-based job queue that Mastodon uses. If you log into the admin panel, you can find a link to monitor its state.<div class=z2h-image><p class=img><img alt="Sidekiq Dashboard" src=/images/2022/11/Screenshot-2022-11-12-at-1.33.19-PM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Sidekiq Dashboard</div><p>The <strong>Sidekiq</strong> dashboard is the first place you want to look when you feel things are slowing down.<p>In addition, you can find on the admin console <strong>PgHero</strong> that can show you important stats about your database.<div class=z2h-image><p class=img><img alt=PgHero src=/images/2022/11/Screenshot-2022-11-12-at-9.58.08-PM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>PgHero</div><p>Also there is <a href=https://pgtune.leopard.in.ua/><strong>PgTune</strong></a>, which can help you tune optimize your database when you fill in some values in a web form.<p>Mastodon official documentation recommends you check out <strong>PgTune</strong> if you want to fine-tune your database further. That could be a low-hanging scalability fruit to use from day zero.<div class=z2h-image><p class=img><img alt="PgTune UI" src=/images/2022/11/Screenshot-2022-11-12-at-10.02.02-PM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>PgTune UI</div><p>How you monitor <strong>Mastodon</strong> will vastly depend on where you run it. You might use your cloud provider’s altering mechanism, install an <a href=https://www.elastic.co/elastic-stack>ELK Stack</a> to take things under your control, or do a mixture of both and some more. I’ll keep that part out of the scope of this article.<p>Also, <a href=https://docs.joinmastodon.org/>the official documentation</a> is the right place to begin your search for anything related to fixing, operating, and configuring Mastodon.<h2 id=conclusion>Conclusion</h2><p>That’s so far my experience and notes while installing Mastodon.<p>It took work, and I found myself debugging, looking into error messages, and checking out <code>journalctl</code> errors and <strong>NGINX</strong> access and error log more than I used to do in other guided installations.<p>However, it was <strong>not</strong> the most challenging thing either. The <a href=https://docs.joinmastodon.org/>the official documentation</a> is in good shape, and when things don’t work, the error messages make sense and help you figure out the next steps.<p>So, if you end up having a similar experience to mine, you’ll just need some patience and to tap into your analytical debugging skills a bit more than usual. Which also has been a fun learning experience that led to this article.<p>Hope you find it informative… And may the source be with you 🦄.<hr><h2 id=section-contents>Section Contents</h2><ul><li><p><a href=https://zerotohero.dev/tips/base64-decoding-a-string-in-go/>Base64 Decoding a String in Go</a></p><li><p><a href=https://zerotohero.dev/tips/destructure/>Use Destructuring to Remove Attributes</a></p><li><p><a href=https://zerotohero.dev/tips/getting-the-body-of-an-http-request-with-go/>Getting the Body of an HTTP Request With Go</a></p><li><p><a href=https://zerotohero.dev/tips/lets-create-a-syslog-logger/>Let’s Create a Syslog Logger</a></p><li><p><a href=https://zerotohero.dev/tips/make-your-code-leaner/>Make Your Code Leaner By Extracting Method</a></p><li><p><strong>▶ Who Else Wants to Have Their Own Mastodon Server?</strong></p><li><p><a href=https://zerotohero.dev/tips/microservice-env-vars/>How to Ensure Environment Variables Are Set</a></p><li><p><a href=https://zerotohero.dev/tips/scaling-your-node-api-like-a-boss/>Scaling Your Node.js API Like a Boss</a></p><li><p><a href=https://zerotohero.dev/tips/talkspiffe-stream-setup/>The Live Stream Dream</a></p><li><p><a href=https://zerotohero.dev/tips/zshell-startup-files/>.zprofile, .zshrc, .zenv, OMG! What Do I Put Where?!</a></p><li><p><a href=https://zerotohero.dev/tips/redirect-index-page/>Redirecting a Static Web Page</a></p></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://zerotohero.dev/tags/tips/>tips</a><li><a href=https://zerotohero.dev/tags/setups/>setups</a><li><a href=https://zerotohero.dev/tags/mastodon/>mastodon</a></ul><nav class=paginav></nav></footer></article></main><footer class=footer><span>© <a href=https://zerotohero.dev>Volkan Özçelik</a> and <a href=/vadideki-geyik/team>Team Geyik</a></span><br><br> The content on this website is distributed under a <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en>CC-BY-NC-SA 4.0 license</a>.<br><br><a href=/about/privacy>Privacy Policy</a> | <a href=/about/contact>Contact</a><br><br><br></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });</script><script>var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };</script><script>document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })</script><script>document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';
        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                var content = codeblock.textContent;
                if(codeblock.firstChild.tagName == 'TABLE') {
                    content = Array(...codeblock.firstChild.getElementsByTagName('span')).map((span) => { return span.textContent; }).join('');
                }
                navigator.clipboard.writeText(content);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });</script>