<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title>Zero to Hero - mastodon</title>
    <link rel="self" type="application/atom+xml" href="https://zerotohero.dev/tags/mastodon/atom.xml"/>
    <link rel="alternate" type="text/html" href="https://zerotohero.dev"/>
    <generator uri="https://www.getzola.org/">Zola</generator>
    <updated>2023-05-27T00:00:00+00:00</updated>
    <id>https://zerotohero.dev/tags/mastodon/atom.xml</id>
    <entry xml:lang="en">
        <title>Who Else Wants to Have Their Own Mastodon Server?</title>
        <published>2023-05-27T00:00:00+00:00</published>
        <updated>2023-05-27T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Volkan √ñz√ßelik
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://zerotohero.dev/tips/mastodon-101/"/>
        <id>https://zerotohero.dev/tips/mastodon-101/</id>
        
        <content type="html" xml:base="https://zerotohero.dev/tips/mastodon-101/">
&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;size&amp;#x2F;w1200&amp;#x2F;2024&amp;#x2F;03&amp;#x2F;eli.png&quot; alt=&quot;Uliphant.&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Uliphant.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;&#x2F;h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt; (2024-03-05)&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;vadidekivolkan&quot;&gt;I am back on Twitter&lt;&#x2F;a&gt; . I still think
Elon is a terrible human being and he does not know jack shit about what he‚Äôs
doing; however, Twitter is still the best way to represent the communities I
represent, and spread the word around when needed. I have other reasons to be
back, which I‚Äôll try to expand in this sidenote a bit.&lt;&#x2F;p&gt;
&lt;p&gt;For starters, when you see everyone who despises Elon, still continue
tweeting, it does not make sense to shield you away. I tried that for at
least six months. For &lt;strong&gt;six freaking months&lt;&#x2F;strong&gt;, I was only at Mastodon, not even
glancing at Twitter. But when I checked back, I realized every single person who
was against Elon was still on the platform.&lt;&#x2F;p&gt;
&lt;p&gt;If we don‚Äôt move as a community, my individual resistance is just futile,
and even counterproductive. So, I‚Äôm still on the platform. Yes, Twitter
is a racist, sexist, misogynistic, hatred-fulled dumspster fire; however, no
alternative platform has been strong enough to force it to extinction. For
whatever reason, it‚Äôs still around.&lt;&#x2F;p&gt;
&lt;p&gt;The current Twitter is like a democracy ran by a tyrant. People are
(&lt;em&gt;still&lt;&#x2F;em&gt;) there, because no matter how much it sucks, it is the only platform
that helps them connect to the world at scale. When you run away, you isolate
yourself.&lt;&#x2F;p&gt;
&lt;p&gt;Social isolation is the opposite of social media: Nobody wants that.&lt;&#x2F;p&gt;
&lt;p&gt;So, as long as there is no significant competitor to take its place, this hell
hole of a birdsite will continue to exist. And I will be there being myself, not
giving a flying clue to others.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;After &lt;a href=&quot;https:&#x2F;&#x2F;www.washingtonpost.com&#x2F;business&#x2F;2022&#x2F;11&#x2F;09&#x2F;elon-musk-how-not-to-fire-employees&#x2F;&quot;&gt;all&lt;&#x2F;a&gt;
&lt;a href=&quot;https:&#x2F;&#x2F;www.wired.com&#x2F;story&#x2F;twitter-users-mastodon-meltdown&#x2F;&quot;&gt;the&lt;&#x2F;a&gt;
&lt;a href=&quot;https:&#x2F;&#x2F;variety.com&#x2F;2022&#x2F;digital&#x2F;news&#x2F;mark-cuban-slams-elon-musk-twitter-verification-plan-nightmare-1235429190&#x2F;&quot;&gt;madness&lt;&#x2F;a&gt;
that has been happening in the birdsite,
I flipped the switch and &lt;a href=&quot;http:&#x2F;&#x2F;hachyderm.io&#x2F;@volkan&quot;&gt;joined Mastodon (on Hachyderm,
where all the misfits hang out)&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;With that, I have also wanted to create my own Mastodon instance for a while.&lt;&#x2F;p&gt;
&lt;p&gt;This article summarizes my experiences with the process and provides tips and
tricks to those who wish to follow the same path.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;This Article Applies to&lt;&#x2F;strong&gt; &lt;strong&gt;Mastodon v3.5.3&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;The article here discusses my deployment experience for v3.5.3 of Mastodon. If
you are deploying a different
version, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mastodon&#x2F;mastodon&quot;&gt;make sure to follow the official installation guides&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I‚Äôve recently upgraded to a much newer version, and the installation&#x2F;upgrade
experience was &lt;strong&gt;very&lt;&#x2F;strong&gt; smooth.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;what-is-a-mastodon-instance&quot;&gt;What Is a Mastodon Instance?&lt;&#x2F;h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Interested? Check Out Fedi.Tips&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;For those new to the concept and want to learn more about &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; and the
&lt;strong&gt;Fediverse&lt;&#x2F;strong&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;fedi.tips&#x2F;&quot;&gt;fedi.tips&lt;&#x2F;a&gt; is a great reference.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;To sum it up at a very high level, &lt;strong&gt;Fediverse&lt;&#x2F;strong&gt; is a collection of
independently-run servers. You can create an account in any one of them and
follow, like, comment, and otherwise interact with anyone else with thousands of
other servers.&lt;&#x2F;p&gt;
&lt;p&gt;It‚Äôs like you have a passport tied to a single country. And with that passport,
you can visit any country you like and interact with the people and culture.
So that‚Äôs where the ‚Äú&lt;em&gt;Fed&lt;&#x2F;em&gt;‚Äù of the &lt;strong&gt;Fediverse&lt;&#x2F;strong&gt; comes from: It is
‚Äú&lt;em&gt;federated&lt;&#x2F;em&gt;.‚Äù&lt;&#x2F;p&gt;
&lt;p&gt;Though, if you are at a point to deploy your own Mastodon instance, you probably
already know that üòÄ.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;why-would-you-want-your-own-instance&quot;&gt;Why Would You Want Your Own Instance?&lt;&#x2F;h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Update 2024-05-27&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;I stopped using my personal mastodon instance on &lt;code&gt;z2h.dev&lt;&#x2F;code&gt;;
I have other plans for the domain. I‚Äôm still on Hachyderm, though.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;So, why would anyone want to create their own &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; instance?&lt;&#x2F;p&gt;
&lt;p&gt;The first thing is, with your instance, you have total control over the content
and the community. If you are a &lt;strong&gt;content creator&lt;&#x2F;strong&gt; or someone with relatively
high visibility, it makes perfect sense to have your own Mastodon instance and
interact with people who want the hear what you have to say there.&lt;&#x2F;p&gt;
&lt;p&gt;With this approach, you manage your identity instead of letting your identity
become an advertising opportunity for a billion-dollar corporation.&lt;&#x2F;p&gt;
&lt;p&gt;Secondly, use it as a &lt;strong&gt;microblog&lt;&#x2F;strong&gt;, where you gather your thoughts and share
one-off ideas. If they are not that interesting to others, who cares ü§∑‚Äç‚ôÇÔ∏è? It‚Äôs
your instance, server, ideas, and rules. I use my instance
to write down random &lt;em&gt;to-do&lt;&#x2F;em&gt; notes, share bookmarks to things I might not easily
find later, and so on.&lt;&#x2F;p&gt;
&lt;p&gt;Or you can do it out of &lt;strong&gt;curiosity&lt;&#x2F;strong&gt;: To have fun exploring new technology,
because you can üôÇ. No matter your intention, if you want to create your
instance, here is my recent experience.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;z2h.dev is my Little Kingdom&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;As of now, I‚Äôm running a single-person instance. Like, it‚Äôs only me on the
server, sharing my random stuff. Yet, it‚Äôs public; so people still come and go
and occasionally like and boost the content too.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Having a single-person instance, my compute requirements are minimal. Keep in
mind that as the number of users in your instance increase, so will your compute
requirements.&lt;&#x2F;p&gt;
&lt;p&gt;Mastodon can be a beast to scale up, especially if your community is active,
vibrant, and highly engaged. Which also is an excellent segue to the next
section.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-infra&quot;&gt;The Infra&lt;&#x2F;h2&gt;
&lt;p&gt;Here‚Äôs my current setup:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A single dedicated &lt;a href=&quot;https:&#x2F;&#x2F;www.linode.com&#x2F;&quot;&gt;&lt;strong&gt;Linode&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; server with 2 CPU
cores and 4 GB of Memory.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;pm&#x2F;serv-s3&#x2F;&quot;&gt;&lt;strong&gt;Amazon S3&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; is the backing data store
for static assets.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;cloudfront&#x2F;&quot;&gt;&lt;strong&gt;Amazon CloudFront&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; as a CDN layer in
front of &lt;strong&gt;S3&lt;&#x2F;strong&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;certificate-manager&#x2F;&quot;&gt;&lt;strong&gt;AWS Certificate Manager&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; to
manage TLS certificates for the static assets (files.z2h.dev).&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;certbot.eff.org&#x2F;&quot;&gt;&lt;strong&gt;Certbot&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; to do the same for the content at
z2h.dev.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Linode DNS&lt;&#x2F;strong&gt;, to manage the DNS records on the Linode end.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Linode Cloud Firewall&lt;&#x2F;strong&gt; because I want my box to be safe.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Linode Backups&lt;&#x2F;strong&gt; because I don‚Äôt want to worry about losing data.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.mailgun.com&#x2F;&quot;&gt;&lt;strong&gt;Mailgun&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; as the SMTP server because using a
local SMTP can be problematic, especially when&#x2F;if I want to extend the server
to a larger audience. You should
follow &lt;a href=&quot;https:&#x2F;&#x2F;documentation.mailgun.com&#x2F;&quot;&gt;Mailgun‚Äôs official documentation&lt;&#x2F;a&gt;
for SMTP configuration.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Here‚Äôs what my current server utilization looks like:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-7.48.38-AM.png&quot; alt=&quot;Linode server utilization.&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Linode server utilization.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;It‚Äôs not much because there is not much going on. Yet, it also shows that the
above specs are more than adequate to run your own Mastodon instance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;server-version&quot;&gt;Server Version&lt;&#x2F;h2&gt;
&lt;p&gt;I‚Äôm running an Ubuntu server (&lt;em&gt;which&lt;&#x2F;em&gt; &lt;a href=&quot;https:&#x2F;&#x2F;docs.joinmastodon.org&#x2F;admin&#x2F;install&#x2F;&quot;&gt;&lt;em&gt;Mastodon official
docs&lt;&#x2F;em&gt;&lt;&#x2F;a&gt; &lt;em&gt;recommend, too&lt;&#x2F;em&gt;) with the
following version:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;Distributor ID:	Ubuntu
&lt;&#x2F;span&gt;&lt;span&gt;Description:    Ubuntu 22.10
&lt;&#x2F;span&gt;&lt;span&gt;Release:        22.10
&lt;&#x2F;span&gt;&lt;span&gt;Codename:       kinetic
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;compute-and-memory-requirements&quot;&gt;Compute and Memory Requirements&lt;&#x2F;h2&gt;
&lt;p&gt;Regarding resource utilization, I‚Äôm coasting at &lt;strong&gt;1GB&lt;&#x2F;strong&gt; of ram and almost zero
CPU (because only one person, me, is posting). So if you want to run a
single-person instance, a VPS that gives you 2gigs of RAM and some minimal CPU
would work for your needs.&lt;&#x2F;p&gt;
&lt;p&gt;Though, your compute, and memory requirements be &lt;strong&gt;much&lt;&#x2F;strong&gt; higher depending on
the traffic and activity on your instance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;securing-the-machine&quot;&gt;Securing The Machine&lt;&#x2F;h2&gt;
&lt;p&gt;Since this is a &lt;a href=&quot;https:&#x2F;&#x2F;www.linode.com&#x2F;&quot;&gt;&lt;strong&gt;Linode&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; box, I‚Äôve followed Linode‚Äô
s security recommendations. I won‚Äôt detail them here because the way you secure
your system will also depend on what you plan to use; however, you can follow
the excellent documentation that Linode has on those topics:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.linode.com&#x2F;docs&#x2F;guides&#x2F;set-up-and-secure&#x2F;&quot;&gt;Setting Up and Securing a Compute Instance&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.linode.com&#x2F;docs&#x2F;guides&#x2F;using-fail2ban-to-secure-your-server-a-tutorial&#x2F;&quot;&gt;Using Fail2ban to Secure Your Server&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.linode.com&#x2F;docs&#x2F;guides&#x2F;set-up-web-server-host-website&#x2F;&quot;&gt;Set Up a Web Server and Host a Website&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;firewall-rules&quot;&gt;Firewall Rules&lt;&#x2F;h2&gt;
&lt;p&gt;I don‚Äôt have that complicated of a firewall setup. Here is what it looks like:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.00.11-AM.png&quot; alt=&quot;Linode firewall rules.&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Linode firewall rules.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Inbound&lt;&#x2F;strong&gt;
&lt;ul&gt;
&lt;li&gt;Allow inbound ssh to a single IP&lt;&#x2F;li&gt;
&lt;li&gt;Accept all inbound HTTP&lt;&#x2F;li&gt;
&lt;li&gt;Accept all inbound HTTPS&lt;&#x2F;li&gt;
&lt;li&gt;Deny everything else&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Outbound&lt;&#x2F;strong&gt;
&lt;ul&gt;
&lt;li&gt;Allow everything&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Which is good enough for the purpose of this application.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;dns-settings&quot;&gt;DNS Settings&lt;&#x2F;h2&gt;
&lt;p&gt;For the sake of completeness, I‚Äôll share the DNS settings too. Here‚Äôs what it
looks like:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.03.45-AM.png&quot; alt=&quot;SOA, NS, MX, A, AAAA&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;SOA, NS, MX, A, AAAA&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.03.57-AM.png&quot; alt=&quot;CNAME, TXT, SRV, CAA&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;CNAME, TXT, SRV, CAA&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;The &lt;strong&gt;CNAME&lt;&#x2F;strong&gt; records are there for &lt;a href=&quot;https:&#x2F;&#x2F;www.mailgun.com&#x2F;&quot;&gt;&lt;strong&gt;Mailgun&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; to
be able to validate the domain; you can check its documentation for instructions
about how to set it up.&lt;&#x2F;p&gt;
&lt;p&gt;Also, note that a &lt;strong&gt;CNAME&lt;&#x2F;strong&gt; record for files.z2h.dev points to an
&lt;a href=&quot;https:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AmazonCloudFront&quot;&gt;&lt;strong&gt;Amazon CloudFront&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; CDN;
we‚Äôll come to that soon.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;strong&gt;TXT&lt;&#x2F;strong&gt; records are for &lt;a href=&quot;https:&#x2F;&#x2F;www.mailgun.com&#x2F;blog&#x2F;deliverability&#x2F;spf-records-basics&#x2F;&quot;&gt;**Mailgun SPF Validation
**&lt;&#x2F;a&gt; and for
&lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;certificate-manager&#x2F;&quot;&gt;&lt;strong&gt;AWS Certificate Manager&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; to
issue and verify certificates to the static assets served at files.z2h.dev on an
AWS S3 bucket.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;cloudfront-setup&quot;&gt;CloudFront Setup&lt;&#x2F;h2&gt;
&lt;p&gt;The thing about &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; is it will store files. Lots of files. Images,
memes, animated gifs, videos‚Ä¶ they need to go somewhere. And the local disk of
your machine is not the best place to put them.&lt;&#x2F;p&gt;
&lt;p&gt;In my current setup, I‚Äôm using an &lt;strong&gt;S3&lt;&#x2F;strong&gt; bucket backed up by &lt;strong&gt;CloudFront&lt;&#x2F;strong&gt; to
sort that out.&lt;&#x2F;p&gt;
&lt;p&gt;Here are the &lt;strong&gt;CloudFront&lt;&#x2F;strong&gt; distribution settings for files.z2h.dev for
reference:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.19.45-AM.png&quot; alt=&quot;CloudFront: Main Settings&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;CloudFront: Main Settings&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.20.10-AM.png&quot; alt=&quot;CloudFront: Origin Settings&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;CloudFront: Origin Settings&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.20.20-AM.png&quot; alt=&quot;CloudFront: Behaviors&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;CloudFront: Behaviors&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;s3-bucket-settings&quot;&gt;S3 Bucket Settings&lt;&#x2F;h2&gt;
&lt;p&gt;The &lt;strong&gt;CloudFront&lt;&#x2F;strong&gt; uses an &lt;strong&gt;S3 Bucket&lt;&#x2F;strong&gt; as its origin. Here are the details of
the bucket.&lt;&#x2F;p&gt;
&lt;p&gt;I have set up a &lt;strong&gt;bucket policy&lt;&#x2F;strong&gt; to publicly allow GET operations on the
bucket.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;json&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-json &quot;&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Version&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;2012-10-17&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Statement&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: [
&lt;&#x2F;span&gt;&lt;span&gt;        {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Sid&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Allow Public Access to All Objects&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Effect&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Allow&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Principal&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Action&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;s3:GetObject&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;Resource&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;arn:aws:s3:::files.z2h.dev&#x2F;*&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;    ]
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I also had to &lt;a href=&quot;https:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;AmazonS3&#x2F;latest&#x2F;userguide&#x2F;acl-overview.html&quot;&gt;&lt;strong&gt;enable access control lists&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt; on
the bucket for my &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; instance to push stuff to it without raising
errors. So here‚Äôs how that part looks on the console:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-8.44.55-AM.png&quot; alt=&quot;Bucket ACL Rules&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Bucket ACL Rules&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Without these ACL rules, Mastodon could not upload files to the bucket.&lt;&#x2F;p&gt;
&lt;p&gt;Other than that, everything on the bucket is in its default settings.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;setting-up-mastodon-the-hard-way&quot;&gt;Setting Up Mastodon The Hard Way&lt;&#x2F;h2&gt;
&lt;p&gt;Now, we come to the fun part. You can install &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;As a set of &lt;strong&gt;Docker&lt;&#x2F;strong&gt; containers (using docker-compose).&lt;&#x2F;li&gt;
&lt;li&gt;As a &lt;strong&gt;Kubernetes&lt;&#x2F;strong&gt; deployment.&lt;&#x2F;li&gt;
&lt;li&gt;Or as a bare-metal installation directly on your server.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I tried the &lt;strong&gt;Docker&lt;&#x2F;strong&gt; installation route but could not make it work. It might
be because I was using an RC version instead of a stable one, or maybe because I
missed a step during the installation; however, I had better luck with the
bare-metal installation, so I‚Äôll explain that in this article.&lt;&#x2F;p&gt;
&lt;p&gt;Besides, a bare-metal install will give you the best performance benefit
compared to the alternatives.&lt;&#x2F;p&gt;
&lt;p&gt;So there are no helm templates, no Docker compose files‚Ä¶ We‚Äôre gonna do this
&lt;strong&gt;the hard way&lt;&#x2F;strong&gt; (&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;kelseyhightower&#x2F;kubernetes-the-hard-way&quot;&gt;&lt;em&gt;Kelsey&lt;&#x2F;em&gt;&lt;&#x2F;a&gt;, anyone?)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;you-ll-need-an-older-version-of-yarn&quot;&gt;You‚Äôll Need An Older Version of &lt;code&gt;yarn&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;One of the most significant issues you are likely going to
face &lt;a href=&quot;https:&#x2F;&#x2F;docs.joinmastodon.org&#x2F;admin&#x2F;install&#x2F;&quot;&gt;is if you follow the official docs&lt;&#x2F;a&gt;.
As of the time of this writing (&lt;em&gt;late 2022&lt;&#x2F;em&gt;), the docs‚Äô instruction on
installing &lt;code&gt;node&lt;&#x2F;code&gt; and &lt;code&gt;yarn&lt;&#x2F;code&gt; is inadequate and incomplete, and if you follow
them step-by-step, you‚Äôll likely fail while bundling the static assets.&lt;&#x2F;p&gt;
&lt;p&gt;The gist is:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;You need an &lt;strong&gt;older&lt;&#x2F;strong&gt; version of &lt;code&gt;yarn&lt;&#x2F;code&gt; (&lt;strong&gt;&lt;em&gt;v1.x&lt;&#x2F;em&gt;&lt;&#x2F;strong&gt;) to bundle static assets.&lt;&#x2F;li&gt;
&lt;li&gt;However, you need &lt;strong&gt;the most recent&lt;&#x2F;strong&gt; &lt;code&gt;node&lt;&#x2F;code&gt; version for security and
stability.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I was able to do that by‚Ä¶&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Installing the recent versions of &lt;code&gt;node&lt;&#x2F;code&gt; and yarn on the system,&lt;&#x2F;li&gt;
&lt;li&gt;And then patching the &lt;code&gt;yarn&lt;&#x2F;code&gt;
binaries &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;yarnpkg&#x2F;yarn&#x2F;releases&#x2F;tag&#x2F;v1.22.19&quot;&gt;with the most recent v1.x release that I could find&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The following sections outline how I managed to do that.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;install-node-and-npm&quot;&gt;Install &lt;code&gt;node&lt;&#x2F;code&gt; and &lt;code&gt;npm&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;First, install the recent version of &lt;code&gt;node&lt;&#x2F;code&gt; and &lt;code&gt;npm&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo apt install curl wget gnupg apt-transport-https \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;lsb-release ca-certificates
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Install node.
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# You can also try a newer version of Node.
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# I&amp;#39;m using v18.x as of now.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_18.x &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;bash -
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Check node and npm versions.
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;node -v
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# v18.7.0
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;npm -v
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# 6.14.17
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;You Might Want to Use &lt;code&gt;nvm&lt;&#x2F;code&gt;&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Note that you might want to use &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nvm-sh&#x2F;nvm&quot;&gt;&lt;code&gt;nvm&lt;&#x2F;code&gt; (&lt;em&gt;Node Version Manager&lt;&#x2F;em&gt;)&lt;&#x2F;a&gt;&lt;br &#x2F;&gt;
to switch between different versions of &lt;code&gt;node&lt;&#x2F;code&gt;.
That might be helpful if your Mastodon instance does not function&lt;br &#x2F;&gt;
properly using a particular version of &lt;code&gt;node&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;create-an-unprivileged-mastodon-user&quot;&gt;Create an Unprivileged &lt;code&gt;mastodon&lt;&#x2F;code&gt; User&lt;&#x2F;h2&gt;
&lt;p&gt;The next thing is to create a dedicated user to run &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt;. This is
&lt;strong&gt;recommended&lt;&#x2F;strong&gt; because Mastodon is a &lt;a href=&quot;https:&#x2F;&#x2F;www.ruby-lang.org&#x2F;en&#x2F;&quot;&gt;ruby&lt;&#x2F;a&gt;
monolith, and switching to different user accounts is a hassle-free way to
experiment with different Ruby versions.&lt;&#x2F;p&gt;
&lt;p&gt;Besides, having a dedicated, unprivileged user is a good security practice.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Add a `mastodon` user, if you haven&amp;#39;t already done so
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;adduser --disabled-login mastodon
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Set a password for the user:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo passwd mastodon
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Switch to that user:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo su - mastodon
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Validate that we are on the correct user account:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;whoami
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# mastodon
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;configure-npm-to-work-without-root-privileges&quot;&gt;Configure &lt;code&gt;npm&lt;&#x2F;code&gt; to Work Without Root Privileges&lt;&#x2F;h2&gt;
&lt;p&gt;Next, we‚Äôll configure &lt;code&gt;npm&lt;&#x2F;code&gt; to work rootless because we are not allowed to
do &lt;code&gt;sudo&lt;&#x2F;code&gt; for the &lt;code&gt;mastodon&lt;&#x2F;code&gt; user.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo su - mastodon
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;mkdir ~&#x2F;.npm-global
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;npm config set prefix &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;~&#x2F;.npm-global&amp;#39;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Update ~&#x2F;.profile with this:
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# export PATH=~&#x2F;.npm-global&#x2F;bin:$PATH
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# Then source it to use the new $PATH:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;source &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;~&#x2F;.profile
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;patch-yarn&quot;&gt;Patch &lt;code&gt;yarn&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;strong&gt;This is the critical part&lt;&#x2F;strong&gt;. You‚Äôll need to use the &lt;code&gt;**v1.x**&lt;&#x2F;code&gt; version
of &lt;code&gt;yarn&lt;&#x2F;code&gt; (&lt;em&gt;at least when this article is written, that‚Äôs the case&lt;&#x2F;em&gt;). If you
install &lt;code&gt;yarn&lt;&#x2F;code&gt; following the documentation, you‚Äôll get a much higher version,
which will cause errors when bundling static asses for the web application.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo su - mastodon
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;wget https:&#x2F;&#x2F;github.com&#x2F;yarnpkg&#x2F;yarn&#x2F;releases&#x2F;\
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;download&#x2F;v1.22.19&#x2F;yarn-v1.22.19.tar.gz
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;tar -xzvf yarn-v1.22.19.tar.gz 
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; yarn-v1.22.19&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; bin&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;cp yarn &#x2F;home&#x2F;mastodon&#x2F;.npm-global&#x2F;bin&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;cp yarnpkg &#x2F;home&#x2F;mastodon&#x2F;.npm-global&#x2F;bin&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; ..
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;cp bin&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; &#x2F;home&#x2F;mastodon&#x2F;.npm-global&#x2F;bin
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That will hopefully take care of your possible &lt;code&gt;yarn&lt;&#x2F;code&gt; problems. If not, you can
find yourself experimenting with things a bit. Honestly, this version
incompatibility was the most challenging part. That took &lt;strong&gt;hours&lt;&#x2F;strong&gt; for me to
fix. I‚Äôm sharing it here so that others don‚Äôt suffer the same pains I‚Äôve had.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;install-postgres&quot;&gt;Install Postgres&lt;&#x2F;h2&gt;
&lt;p&gt;Mastodon uses Postgres (&lt;em&gt;or any Postgres-compatible DB&lt;&#x2F;em&gt;) as its backend
database. So, we‚Äôll install that to our instance too.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo su
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;wget -O &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;postgresql.asc \&lt;&#x2F;span&gt;&lt;span style=&quot;background-color:#932b1e;color:#fdf4c1;&quot;&gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;https:&#x2F;&#x2F;www.postgresql.org&#x2F;media&#x2F;keys&#x2F;ACCC4CF8.asc
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;quot;deb [signed-by=&#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;postgresql.asc] \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;http:&#x2F;&#x2F;apt.postgresql.org&#x2F;pub&#x2F;repos&#x2F;apt \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;lsb_release -cs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;)-pgdg main&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;postgresql.list
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;apt update
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;apt install -y \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  imagemagick ffmpeg libpq-dev libxml2-dev libxslt1-dev \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  file git-core g++ libprotobuf-dev protobuf-compiler \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  pkg-config nodejs gcc autoconf \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  bison build-essential libssl-dev libyaml-dev libreadline6-dev \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  nginx redis-server redis-tools postgresql postgresql-contrib \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  certbot python3-certbot-nginx libidn11-dev libicu-dev \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;  libjemalloc-dev
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;install-ruby&quot;&gt;Install Ruby&lt;&#x2F;h2&gt;
&lt;p&gt;Mastodon is a &lt;a href=&quot;https:&#x2F;&#x2F;ruby-lang.org&#x2F;&quot;&gt;Ruby&lt;&#x2F;a&gt; server, so we‚Äôll, for sure,
need &lt;code&gt;ruby&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;su - mastodon
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;git clone https:&#x2F;&#x2F;github.com&#x2F;rbenv&#x2F;rbenv.git ~&#x2F;.rbenv
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;~&#x2F;.rbenv &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;src&#x2F;configure &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;make -C src
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;export PATH=&amp;quot;$HOME&#x2F;.rbenv&#x2F;bin:$PATH&amp;quot;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;~&#x2F;.bashrc
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;echo &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;eval &amp;quot;$(rbenv init -)&amp;quot;&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;~&#x2F;.bashrc
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;exec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; bash
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;git clone https:&#x2F;&#x2F;github.com&#x2F;rbenv&#x2F;ruby-build.git \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;~&#x2F;.rbenv&#x2F;plugins&#x2F;ruby-build
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once that‚Äôs done, install the &lt;code&gt;ruby&lt;&#x2F;code&gt; version that we need:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;RUBY_CONFIGURE_OPTS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;--with-jemalloc &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;rbenv install 3.0.3
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;rbenv global 3.0.3
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We‚Äôll also need &lt;code&gt;bundler&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;gem install bundler --no-document
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;configure-postgres&quot;&gt;Configure Postgres&lt;&#x2F;h2&gt;
&lt;p&gt;Next up, we‚Äôll configure our database:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo -u postgres psql
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;CREATE USER mastodon CREATEDB&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;\q
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And, that‚Äôs it üôå.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;set-up-mastodon&quot;&gt;Set Up Mastodon&lt;&#x2F;h2&gt;
&lt;p&gt;Now it‚Äôs time to set up the elephant in the room.&lt;&#x2F;p&gt;
&lt;p&gt;We‚Äôll build &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; straight from the source code.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;git clone https:&#x2F;&#x2F;github.com&#x2F;tootsuite&#x2F;mastodon.git \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;live &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;&amp;amp;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; live
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;git checkout \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;$(git tag -l &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;grep -v &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;rc[0-9]*$&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sort -V &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;tail -n 1)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;bundle config deployment &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;true&amp;#39;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;bundle config without &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;development test&amp;#39;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;bundle install -j$(getconf _NPROCESSORS_ONLN)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;yarn install --pure-lockfile
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After all these set, we‚Äôll run the interactive setup wizard:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;RAILS_ENV&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;production &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;bundle exec rake mastodon:setup
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The wizard will ask you certain questions. I‚Äôve added my answers to some of
those, redacting sensitive parts.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;LOCAL_DOMAIN&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;z2h.dev
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SINGLE_USER_MODE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;false
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;DB_HOST&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&#x2F;var&#x2F;run&#x2F;postgresql
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;DB_PORT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;5432
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;DB_NAME&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;mastodon_production
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;DB_USER&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;mastodon
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;DB_PASS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;REDIS_HOST&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;localhost
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;REDIS_PORT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;6379
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;REDIS_PASSWORD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_ENABLED&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;true
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_PROTOCOL&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;https
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_BUCKET&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;files.z2h.dev
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_REGION&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;us-west-2
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_HOSTNAME&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;s3.us-west-2.amazonaws.com
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;AWS_ACCESS_KEY_ID&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;AKIA&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;REDACTED&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;AWS_SECRET_ACCESS_KEY&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;Yj&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;REDACTED&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;S3_ALIAS_HOST&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;files.z2h.dev
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_SERVER&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;smtp.mailgun.org
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_PORT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;587
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_LOGIN&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;postmaster@z2h.dev
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_PASSWORD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;b&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;REDACTED&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa5c4b;&quot;&gt;]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_AUTH_METHOD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;plain
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_OPENSSL_VERIFY_MODE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;none
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;SMTP_FROM_ADDRESS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b8bb26;&quot;&gt;&amp;#39;Mastodon &amp;lt;notifications@z2h.dev&amp;gt;&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once the installer finishes successfully, you‚Äôll get a prompt similar to this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;All done! You can now power on the Mastodon server üêò
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;Do you want to create an admin user straight away? Yes
&lt;&#x2F;span&gt;&lt;span&gt;Username: $usernameYouChoseDuringSetup
&lt;&#x2F;span&gt;&lt;span&gt;E-mail: $emailYouChoseDuringSetup
&lt;&#x2F;span&gt;&lt;span&gt;You can login with the password: $someRandomPassword
&lt;&#x2F;span&gt;&lt;span&gt;You can change your password once you login.
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;The Installer Gave Me an &lt;code&gt;emoji-mart&lt;&#x2F;code&gt;-Related Error&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Before triggering the setup, I also had to manually&lt;br &#x2F;&gt;
&lt;code&gt;npm install --save emoji-mart&lt;&#x2F;code&gt; in the &lt;code&gt;live&lt;&#x2F;code&gt; folder&lt;br &#x2F;&gt;
because the installer complained otherwise.&lt;&#x2F;p&gt;
&lt;p&gt;I don‚Äôt know if it will be fixed by the time you use the latest and&lt;br &#x2F;&gt;
greatest Mastodon. Yet, I wanted to share it here in case you&lt;br &#x2F;&gt;
bump into a similar issue.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;getting-tls-certificates&quot;&gt;Getting TLS Certificates&lt;&#x2F;h2&gt;
&lt;p&gt;Once you have your compute instance, DNS, and ingress firewall set up, you can
fetch a TLS certificate from &lt;a href=&quot;https:&#x2F;&#x2F;letsencrypt.org&#x2F;&quot;&gt;Let‚Äôs Encrypt&lt;&#x2F;a&gt;
using &lt;a href=&quot;https:&#x2F;&#x2F;certbot.eff.org&#x2F;&quot;&gt;&lt;code&gt;certbot&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo certbot certonly --standalone -d z2h.dev
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The command above will temporarily spin up a web server, do the necessary
negotiations and fetch a TLS certificate for the domain &lt;code&gt;z2h.dev&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Also, ensure that certbot timer is enabled via &lt;code&gt;systemctl status certbot.timer&lt;&#x2F;code&gt;.
If the timer is not enabled, make sure to enable it
using &lt;code&gt;systemctl enable certbot.timer&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;volkan@z2h-dev:~$ systemctl status certbot.timer
&lt;&#x2F;span&gt;&lt;span&gt;‚óè certbot.timer - Run certbot twice daily
&lt;&#x2F;span&gt;&lt;span&gt;     Loaded: loaded (&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;certbot.timer; 
&lt;&#x2F;span&gt;&lt;span&gt;enabled; preset: enabled)
&lt;&#x2F;span&gt;&lt;span&gt;     Active: active (waiting) 
&lt;&#x2F;span&gt;&lt;span&gt;since Fri 2022-11-11 03:02:18 PST; 1 day 9h ago
&lt;&#x2F;span&gt;&lt;span&gt;      Until: Fri 2022-11-11 03:02:18 PST; 1 day 9h ago
&lt;&#x2F;span&gt;&lt;span&gt;    Trigger: Sat 2022-11-12 22:37:01 PST; 10h left
&lt;&#x2F;span&gt;&lt;span&gt;   Triggers: ‚óè certbot.service
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Also, make sure that your certificates are where they need to be:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo ls -al &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;z2h.dev
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# The output should look something like this:
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# drwxr-xr-x 2 root root 4096 Nov 11 02:41 .
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# drwx------ 3 root root 4096 Nov 11 02:41 ..
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# lrwxrwxrwx 1 root root   31 Nov 11 02:41 cert.pem 
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# -&amp;gt; ..&#x2F;..&#x2F;archive&#x2F;z2h.dev&#x2F;cert1.pem
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# lrwxrwxrwx 1 root root   32 Nov 11 02:41 chain.pem 
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# -&amp;gt; ..&#x2F;..&#x2F;archive&#x2F;z2h.dev&#x2F;chain1.pem
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# lrwxrwxrwx 1 root root   36 Nov 11 02:41 
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# fullchain.pem -&amp;gt; ..&#x2F;..&#x2F;archive&#x2F;z2h.dev&#x2F;fullchain1.pem
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# lrwxrwxrwx 1 root root   34 Nov 11 02:41 privkey.pem 
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# -&amp;gt; ..&#x2F;..&#x2F;archive&#x2F;z2h.dev&#x2F;privkey1.pem
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#928374;&quot;&gt;# -rw-r--r-- 1 root root  692 Nov 11 02:41 README
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;configure-nginx&quot;&gt;Configure NGINX&lt;&#x2F;h2&gt;
&lt;p&gt;Now that we have our certificates in place, we can configure &lt;strong&gt;NGINX&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Here‚Äôs my &lt;code&gt;&#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;z2h.dev.conf&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;map $http_upgrade $connection_upgrade {
&lt;&#x2F;span&gt;&lt;span&gt;  default upgrade;
&lt;&#x2F;span&gt;&lt;span&gt;  &amp;#39;&amp;#39;      close;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;upstream backend {
&lt;&#x2F;span&gt;&lt;span&gt;    server 127.0.0.1:3000 fail_timeout=0;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;upstream streaming {
&lt;&#x2F;span&gt;&lt;span&gt;    server 127.0.0.1:4000 fail_timeout=0;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;proxy_cache_path &#x2F;var&#x2F;cache&#x2F;nginx levels=1:2 
&lt;&#x2F;span&gt;&lt;span&gt;  keys_zone=CACHE:10m inactive=7d max_size=1g;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;server {
&lt;&#x2F;span&gt;&lt;span&gt;  listen 80;
&lt;&#x2F;span&gt;&lt;span&gt;  listen [::]:80;
&lt;&#x2F;span&gt;&lt;span&gt;  server_name z2h.dev;
&lt;&#x2F;span&gt;&lt;span&gt;  root &#x2F;home&#x2F;mastodon&#x2F;live&#x2F;public;
&lt;&#x2F;span&gt;&lt;span&gt;  location &#x2F;.well-known&#x2F;acme-challenge&#x2F; { allow all; }
&lt;&#x2F;span&gt;&lt;span&gt;  location &#x2F; { return 301 https:&#x2F;&#x2F;$host$request_uri; }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;server {
&lt;&#x2F;span&gt;&lt;span&gt;  listen 443 ssl http2;
&lt;&#x2F;span&gt;&lt;span&gt;  listen [::]:443 ssl http2;
&lt;&#x2F;span&gt;&lt;span&gt;  server_name z2h.dev;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_protocols TLSv1.2 TLSv1.3;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_ciphers HIGH:!MEDIUM:!LOW:!aNULL:!NULL:!SHA;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_prefer_server_ciphers on;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_session_cache shared:SSL:10m;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_session_tickets off;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  # Uncomment these lines once you acquire a certificate:
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_certificate     &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;z2h.dev&#x2F;fullchain.pem;
&lt;&#x2F;span&gt;&lt;span&gt;  ssl_certificate_key &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;z2h.dev&#x2F;privkey.pem;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  keepalive_timeout    70;
&lt;&#x2F;span&gt;&lt;span&gt;  sendfile             on;
&lt;&#x2F;span&gt;&lt;span&gt;  client_max_body_size 80m;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  root &#x2F;home&#x2F;mastodon&#x2F;live&#x2F;public;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip on;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_disable &amp;quot;msie6&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_vary on;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_proxied any;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_comp_level 6;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_buffers 16 8k;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_http_version 1.1;
&lt;&#x2F;span&gt;&lt;span&gt;  gzip_types text&#x2F;plain text&#x2F;css application&#x2F;json 
&lt;&#x2F;span&gt;&lt;span&gt;    application&#x2F;javascript text&#x2F;xml application&#x2F;xml 
&lt;&#x2F;span&gt;&lt;span&gt;    application&#x2F;xml+rss text&#x2F;javascript 
&lt;&#x2F;span&gt;&lt;span&gt;    image&#x2F;svg+xml image&#x2F;x-icon;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location &#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri @proxy;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location = &#x2F;sw.js {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=604800, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;assets&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;avatars&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;emoji&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;headers&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;packs&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;shortcuts&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;sounds&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, must-revalidate&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ~ ^&#x2F;system&#x2F; {
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Cache-Control 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;public, max-age=2419200, immutable&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    try_files $uri =404;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location ^~ &#x2F;api&#x2F;v1&#x2F;streaming {
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Host $host;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Real-IP $remote_addr;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Forwarded-Proto $scheme;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Proxy &amp;quot;&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_pass http:&#x2F;&#x2F;streaming;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_buffering off;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_redirect off;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_http_version 1.1;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Upgrade $http_upgrade;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Connection $connection_upgrade;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header Strict-Transport-Security 
&lt;&#x2F;span&gt;&lt;span&gt;      &amp;quot;max-age=63072000; includeSubDomains&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    tcp_nodelay on;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  location @proxy {
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Host $host;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Real-IP $remote_addr;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header X-Forwarded-Proto $scheme;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Proxy &amp;quot;&amp;quot;;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_pass_header Server;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_pass http:&#x2F;&#x2F;backend;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_buffering on;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_redirect off;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_http_version 1.1;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Upgrade $http_upgrade;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_set_header Connection $connection_upgrade;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_cache CACHE;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_cache_valid 200 7d;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_cache_valid 410 24h;
&lt;&#x2F;span&gt;&lt;span&gt;    proxy_cache_use_stale error timeout 
&lt;&#x2F;span&gt;&lt;span&gt;      updating http_500 http_502 http_503 http_504;
&lt;&#x2F;span&gt;&lt;span&gt;    add_header X-Cached $upstream_cache_status;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    tcp_nodelay on;
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  error_page 404 500 501 502 503 504 &#x2F;500.html;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I‚Äôve copied the
file &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mastodon&#x2F;mastodon&#x2F;blob&#x2F;main&#x2F;dist&#x2F;nginx.conf&quot;&gt;from Mastodon‚Äôs source code repo&lt;&#x2F;a&gt;
and changed &lt;code&gt;example.com&lt;&#x2F;code&gt; to &lt;code&gt;z2h.dev&lt;&#x2F;code&gt; in the file.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;set-up-nginx-to-use-mastodon-user&quot;&gt;Set Up NGINX to Use &lt;code&gt;mastodon&lt;&#x2F;code&gt; User&lt;&#x2F;h2&gt;
&lt;p&gt;One more thing, &lt;code&gt;nginx&lt;&#x2F;code&gt;, by default, uses &lt;code&gt;www-data&lt;&#x2F;code&gt; as a user, and that‚Äîin my
case‚Äîcaused issues when I started Mastodon‚Äôs microservices.
Editing &lt;code&gt;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf&lt;&#x2F;code&gt; and replacing &lt;code&gt;www-data&lt;&#x2F;code&gt; with &lt;code&gt;mastodon&lt;&#x2F;code&gt; fixed
that for me.&lt;&#x2F;p&gt;
&lt;p&gt;Here‚Äôs the entire file for reference:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;user mastodon;
&lt;&#x2F;span&gt;&lt;span&gt;#user www-data;
&lt;&#x2F;span&gt;&lt;span&gt;worker_processes auto;
&lt;&#x2F;span&gt;&lt;span&gt;pid &#x2F;run&#x2F;nginx.pid;
&lt;&#x2F;span&gt;&lt;span&gt;include &#x2F;etc&#x2F;nginx&#x2F;modules-enabled&#x2F;*.conf;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;events {
&lt;&#x2F;span&gt;&lt;span&gt;    worker_connections 768;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;http {
&lt;&#x2F;span&gt;&lt;span&gt;    sendfile on;
&lt;&#x2F;span&gt;&lt;span&gt;    tcp_nopush on;
&lt;&#x2F;span&gt;&lt;span&gt;    types_hash_max_size 2048;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    include &#x2F;etc&#x2F;nginx&#x2F;mime.types;
&lt;&#x2F;span&gt;&lt;span&gt;    default_type application&#x2F;octet-stream;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
&lt;&#x2F;span&gt;&lt;span&gt;    ssl_prefer_server_ciphers on;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log;
&lt;&#x2F;span&gt;&lt;span&gt;    error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    gzip on;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;
&lt;&#x2F;span&gt;&lt;span&gt;    include &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;*;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;link-the-site&quot;&gt;Link the Site&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fabd2f;&quot;&gt;cd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt; &#x2F;etc&#x2F;nginx&#x2F;sites-enabled
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo ln -s ..&#x2F;sites-available&#x2F;z2h.dev.conf
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will make &lt;strong&gt;NGINX&lt;&#x2F;strong&gt; import and use the rules that we‚Äôve defined in the
former section.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;start-nginx&quot;&gt;Start NGINX&lt;&#x2F;h2&gt;
&lt;p&gt;Then we can start &lt;code&gt;nginx&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl restart nginx
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then check the status of the &lt;code&gt;nginx&lt;&#x2F;code&gt; service:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;volkan@z2h-dev:~$ sudo systemctl status nginx
&lt;&#x2F;span&gt;&lt;span&gt;‚óè nginx.service - 
&lt;&#x2F;span&gt;&lt;span&gt;A high performance web server and a reverse proxy server
&lt;&#x2F;span&gt;&lt;span&gt;     Loaded: loaded 
&lt;&#x2F;span&gt;&lt;span&gt;(&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service; enabled; preset: enabled)
&lt;&#x2F;span&gt;&lt;span&gt;     Active: active (running)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So far, all looking good üëå.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;setting-up-systemd-services&quot;&gt;Setting Up &lt;code&gt;systemd&lt;&#x2F;code&gt; Services&lt;&#x2F;h2&gt;
&lt;p&gt;Make sure you have these files under &lt;code&gt;&#x2F;etc&#x2F;systemd&#x2F;system&lt;&#x2F;code&gt;. Again, I‚Äôve copied
them &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mastodon&#x2F;mastodon&#x2F;tree&#x2F;main&#x2F;dist&quot;&gt;from the official Mastodon repository&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;etc-systemd-system-mastodon-sideqik-service&quot;&gt;&lt;code&gt;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mastodon-sideqik.service&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=mastodon-sidekiq
&lt;&#x2F;span&gt;&lt;span&gt;After=network.target
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;User=mastodon
&lt;&#x2F;span&gt;&lt;span&gt;WorkingDirectory=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;RAILS_ENV=production&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;DB_POOL=25&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;MALLOC_ARENA_MAX=2&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;LD_PRELOAD=libjemalloc.so&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;home&#x2F;mastodon&#x2F;.rbenv&#x2F;shims&#x2F;bundle exec sidekiq -c 25
&lt;&#x2F;span&gt;&lt;span&gt;TimeoutSec=15
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;# Proc filesystem
&lt;&#x2F;span&gt;&lt;span&gt;ProcSubset=pid
&lt;&#x2F;span&gt;&lt;span&gt;ProtectProc=invisible
&lt;&#x2F;span&gt;&lt;span&gt;# Capabilities
&lt;&#x2F;span&gt;&lt;span&gt;CapabilityBoundingSet=
&lt;&#x2F;span&gt;&lt;span&gt;# Security
&lt;&#x2F;span&gt;&lt;span&gt;NoNewPrivileges=true
&lt;&#x2F;span&gt;&lt;span&gt;# Sandboxing
&lt;&#x2F;span&gt;&lt;span&gt;ProtectSystem=strict
&lt;&#x2F;span&gt;&lt;span&gt;PrivateTmp=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateDevices=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateUsers=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectHostname=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelLogs=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelModules=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelTunables=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectControlGroups=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET6
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_NETLINK
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_UNIX
&lt;&#x2F;span&gt;&lt;span&gt;RestrictNamespaces=true
&lt;&#x2F;span&gt;&lt;span&gt;LockPersonality=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictRealtime=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictSUIDSGID=true
&lt;&#x2F;span&gt;&lt;span&gt;RemoveIPC=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateMounts=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectClock=true
&lt;&#x2F;span&gt;&lt;span&gt;# System Call Filtering
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallArchitectures=native
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=~@cpu-emulation @debug 
&lt;&#x2F;span&gt;&lt;span&gt;  @keyring @ipc @mount @obsolete @privileged @setuid
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=@chown
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe2
&lt;&#x2F;span&gt;&lt;span&gt;ReadWritePaths=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;etc-systemd-system-mastodon-streaming-service&quot;&gt;&lt;code&gt;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mastodon-streaming.service&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=mastodon-streaming
&lt;&#x2F;span&gt;&lt;span&gt;After=network.target
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;User=mastodon
&lt;&#x2F;span&gt;&lt;span&gt;WorkingDirectory=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;NODE_ENV=production&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;PORT=4000&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;STREAMING_CLUSTER_NUM=1&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;usr&#x2F;bin&#x2F;node .&#x2F;streaming
&lt;&#x2F;span&gt;&lt;span&gt;TimeoutSec=15
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;# Proc filesystem
&lt;&#x2F;span&gt;&lt;span&gt;ProcSubset=pid
&lt;&#x2F;span&gt;&lt;span&gt;ProtectProc=invisible
&lt;&#x2F;span&gt;&lt;span&gt;# Capabilities
&lt;&#x2F;span&gt;&lt;span&gt;CapabilityBoundingSet=
&lt;&#x2F;span&gt;&lt;span&gt;# Security
&lt;&#x2F;span&gt;&lt;span&gt;NoNewPrivileges=true
&lt;&#x2F;span&gt;&lt;span&gt;# Sandboxing
&lt;&#x2F;span&gt;&lt;span&gt;ProtectSystem=strict
&lt;&#x2F;span&gt;&lt;span&gt;PrivateTmp=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateDevices=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateUsers=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectHostname=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelLogs=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelModules=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelTunables=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectControlGroups=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET6
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_NETLINK
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_UNIX
&lt;&#x2F;span&gt;&lt;span&gt;RestrictNamespaces=true
&lt;&#x2F;span&gt;&lt;span&gt;LockPersonality=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictRealtime=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictSUIDSGID=true
&lt;&#x2F;span&gt;&lt;span&gt;RemoveIPC=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateMounts=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectClock=true
&lt;&#x2F;span&gt;&lt;span&gt;# System Call Filtering
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallArchitectures=native
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=~@cpu-emulation @debug 
&lt;&#x2F;span&gt;&lt;span&gt;  @keyring @ipc @memlock @mount @obsolete 
&lt;&#x2F;span&gt;&lt;span&gt;  @privileged @resources @setuid
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe2
&lt;&#x2F;span&gt;&lt;span&gt;ReadWritePaths=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;etc-systemd-system-mastodon-web-service&quot;&gt;&lt;code&gt;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mastodon-web.service&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;txt&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-txt &quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span&gt;[Unit]
&lt;&#x2F;span&gt;&lt;span&gt;Description=mastodon-web
&lt;&#x2F;span&gt;&lt;span&gt;After=network.target
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Service]
&lt;&#x2F;span&gt;&lt;span&gt;Type=simple
&lt;&#x2F;span&gt;&lt;span&gt;User=mastodon
&lt;&#x2F;span&gt;&lt;span&gt;WorkingDirectory=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;RAILS_ENV=production&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;PORT=3000&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;Environment=&amp;quot;LD_PRELOAD=libjemalloc.so&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;ExecStart=&#x2F;home&#x2F;mastodon&#x2F;.rbenv&#x2F;shims&#x2F;bundle exec \
&lt;&#x2F;span&gt;&lt;span&gt;puma -C config&#x2F;puma.rb
&lt;&#x2F;span&gt;&lt;span&gt;ExecReload=&#x2F;bin&#x2F;kill -SIGUSR1 $MAINPID
&lt;&#x2F;span&gt;&lt;span&gt;TimeoutSec=15
&lt;&#x2F;span&gt;&lt;span&gt;Restart=always
&lt;&#x2F;span&gt;&lt;span&gt;# Proc filesystem
&lt;&#x2F;span&gt;&lt;span&gt;ProcSubset=pid
&lt;&#x2F;span&gt;&lt;span&gt;ProtectProc=invisible
&lt;&#x2F;span&gt;&lt;span&gt;# Capabilities
&lt;&#x2F;span&gt;&lt;span&gt;CapabilityBoundingSet=
&lt;&#x2F;span&gt;&lt;span&gt;# Security
&lt;&#x2F;span&gt;&lt;span&gt;NoNewPrivileges=true
&lt;&#x2F;span&gt;&lt;span&gt;# Sandboxing
&lt;&#x2F;span&gt;&lt;span&gt;ProtectSystem=strict
&lt;&#x2F;span&gt;&lt;span&gt;PrivateTmp=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateDevices=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateUsers=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectHostname=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelLogs=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelModules=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectKernelTunables=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectControlGroups=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_INET6
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_NETLINK
&lt;&#x2F;span&gt;&lt;span&gt;RestrictAddressFamilies=AF_UNIX
&lt;&#x2F;span&gt;&lt;span&gt;RestrictNamespaces=true
&lt;&#x2F;span&gt;&lt;span&gt;LockPersonality=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictRealtime=true
&lt;&#x2F;span&gt;&lt;span&gt;RestrictSUIDSGID=true
&lt;&#x2F;span&gt;&lt;span&gt;RemoveIPC=true
&lt;&#x2F;span&gt;&lt;span&gt;PrivateMounts=true
&lt;&#x2F;span&gt;&lt;span&gt;ProtectClock=true
&lt;&#x2F;span&gt;&lt;span&gt;# System Call Filtering
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallArchitectures=native
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=~@cpu-emulation @debug 
&lt;&#x2F;span&gt;&lt;span&gt;  @keyring @ipc @mount @obsolete @privileged @setuid
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=@chown
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe
&lt;&#x2F;span&gt;&lt;span&gt;SystemCallFilter=pipe2
&lt;&#x2F;span&gt;&lt;span&gt;ReadWritePaths=&#x2F;home&#x2F;mastodon&#x2F;live
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[Install]
&lt;&#x2F;span&gt;&lt;span&gt;WantedBy=multi-user.target
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That handles the &lt;code&gt;systemd&lt;&#x2F;code&gt; part of things.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;checking-the-services&quot;&gt;Checking The Services&lt;&#x2F;h2&gt;
&lt;p&gt;Make sure you have all the services are up&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl status mastodon-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fe8019;&quot;&gt;*
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If any of the services are down or disabled, you can enable them:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#282828;color:#fdf4c1aa;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl enable mastodon-web
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl enable mastodon-sideqik
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl enable mastodon-streaming
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl start mastodon-web
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl start mastodon-sideqik
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fdf4c1;&quot;&gt;sudo systemctl start mastodon-streaming
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you didn‚Äôt have any issues so far, you should have a running &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt;
instance that you can browse to the domain you set up (in my case
it‚Äôs &lt;code&gt;z2h.dev&lt;&#x2F;code&gt;. Then, you can log in as an Administrator with
a random password that the installer has provided you during the guided
installation section you‚Äôve followed above.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;securing-mastodon&quot;&gt;Securing Mastodon&lt;&#x2F;h2&gt;
&lt;p&gt;Since we have &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; itself up and running, it‚Äôs time to secure the
instance.&lt;&#x2F;p&gt;
&lt;p&gt;We‚Äôll start with the users.&lt;&#x2F;p&gt;
&lt;p&gt;Ah, as soon as I created the instance, I made a second unprivileged user.&lt;&#x2F;p&gt;
&lt;p&gt;I use the root user only to administer the Mastodon server, and I use the
unprivileged user &lt;a href=&quot;http:&#x2F;&#x2F;z2h.dev&#x2F;@volkan&quot;&gt;z2h.dev&#x2F;@volkan&lt;&#x2F;a&gt; to post things on
the site.&lt;&#x2F;p&gt;
&lt;p&gt;The next thing you &lt;strong&gt;MUST&lt;&#x2F;strong&gt; do is
to &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;McKael&#x2F;mastodon-documentation&#x2F;blob&#x2F;master&#x2F;Using-Mastodon&#x2F;2FA.md&quot;&gt;enable 2FA for all users you control&lt;&#x2F;a&gt;.
&lt;strong&gt;DO NOT&lt;&#x2F;strong&gt; defer this. &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; is getting quite popular, which also means
it‚Äôs attracting many people with bad intentions. Due to a zero-day
vulnerability, you would not want your server to become a spammers‚Äô barbeque
backyard. &lt;strong&gt;2FA&lt;&#x2F;strong&gt; is an added layer of security that makes it extra hard for
attackers to impersonate you.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;scaling-up-mastodon&quot;&gt;Scaling Up Mastodon&lt;&#x2F;h2&gt;
&lt;p&gt;All the services &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; relies upon (&lt;em&gt;i.e., Redis, Postgres, etc&lt;&#x2F;em&gt;.) can
scale independently. Mastodon is, in itself, stateless. That means you can put
several Mastodon servers behind a load balancer and point them to the same
Postgres and Redis, which will take care of scalability for a long time.&lt;&#x2F;p&gt;
&lt;p&gt;Here‚Äôs a high-level outline of how that might look like:&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;mastodon-lb.png&quot; alt=&quot;Scaling Up Mastodon&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Scaling Up Mastodon&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;If things get even crazier, you‚Äôll have to come up with solutions to the
bottleneck you are facing. Like tuning Redis, adding read replicas; doing the
same to Postgres; tuning &lt;strong&gt;NGINX&lt;&#x2F;strong&gt;, maybe backing &lt;strong&gt;NGINX&lt;&#x2F;strong&gt; with another cloud
load balancer; sharding the data, geographically sharding the users‚Ä¶ the list
can go on.&lt;&#x2F;p&gt;
&lt;p&gt;However, if you have reached that scale, the thing has become your full-time
job, and you probably have a team of intelligent engineers to sort out these
problems with you üôÇ. If not, then you don‚Äôt have to worry about future issues.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;monitoring-and-operating-mastodon&quot;&gt;Monitoring and Operating Mastodon&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;sidekiq.org&#x2F;&quot;&gt;SideKiq&lt;&#x2F;a&gt; is the Ruby-based job queue that Mastodon uses.
If you log into the admin panel, you can find a link to monitor its state.&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-1.33.19-PM.png&quot; alt=&quot;Sidekiq Dashboard&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;Sidekiq Dashboard&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;The &lt;strong&gt;Sidekiq&lt;&#x2F;strong&gt; dashboard is the first place you want to look when you feel
things are slowing down.&lt;&#x2F;p&gt;
&lt;p&gt;In addition, you can find on the admin console &lt;strong&gt;PgHero&lt;&#x2F;strong&gt; that can show you
important stats about your database.&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-9.58.08-PM.png&quot; alt=&quot;PgHero&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;PgHero&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Also there is &lt;a href=&quot;https:&#x2F;&#x2F;pgtune.leopard.in.ua&#x2F;&quot;&gt;&lt;strong&gt;PgTune&lt;&#x2F;strong&gt;&lt;&#x2F;a&gt;, which can help you
tune optimize your database when you fill in some values in a web form.&lt;&#x2F;p&gt;
&lt;p&gt;Mastodon official documentation recommends you check out &lt;strong&gt;PgTune&lt;&#x2F;strong&gt; if you want
to fine-tune your database further. That could be a low-hanging scalability
fruit to use from day zero.&lt;&#x2F;p&gt;

&lt;div class=&quot;z2h-image&quot;&gt;
    &lt;p class=&quot;img&quot;&gt;&lt;img src=&quot;&amp;#x2F;images&amp;#x2F;2022&amp;#x2F;11&amp;#x2F;Screenshot-2022-11-12-at-10.02.02-PM.png&quot; alt=&quot;PgTune UI&quot;&#x2F;&gt;&lt;&#x2F;p&gt;
    &lt;p class=&quot;alt&quot; style=&quot;text-align: center; font-style: italic;
      margin-top: -1.125em;
      font-size: 1em;&quot;&gt;PgTune UI&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;How you monitor &lt;strong&gt;Mastodon&lt;&#x2F;strong&gt; will vastly depend on where you run it. You might
use your cloud provider‚Äôs altering mechanism, install
an &lt;a href=&quot;https:&#x2F;&#x2F;www.elastic.co&#x2F;elastic-stack&quot;&gt;ELK Stack&lt;&#x2F;a&gt; to take things under your
control, or do a mixture of both and some more. I‚Äôll keep that part out of the
scope of this article.&lt;&#x2F;p&gt;
&lt;p&gt;Also, &lt;a href=&quot;https:&#x2F;&#x2F;docs.joinmastodon.org&#x2F;&quot;&gt;the official documentation&lt;&#x2F;a&gt; is the right
place to begin your search for anything related to fixing, operating, and
configuring Mastodon.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;That‚Äôs so far my experience and notes while installing Mastodon.&lt;&#x2F;p&gt;
&lt;p&gt;It took work, and I found myself debugging, looking into error messages, and
checking out &lt;code&gt;journalctl&lt;&#x2F;code&gt; errors and &lt;strong&gt;NGINX&lt;&#x2F;strong&gt; access and error log more than I
used to do in other guided installations.&lt;&#x2F;p&gt;
&lt;p&gt;However, it was &lt;strong&gt;not&lt;&#x2F;strong&gt; the most challenging thing either.
The &lt;a href=&quot;https:&#x2F;&#x2F;docs.joinmastodon.org&#x2F;&quot;&gt;the official documentation&lt;&#x2F;a&gt; is in good
shape, and when things don‚Äôt work, the error messages make sense and help you
figure out the next steps.&lt;&#x2F;p&gt;
&lt;p&gt;So, if you end up having a similar experience to mine, you‚Äôll just need some
patience and to tap into your analytical debugging skills a bit more than usual.
Which also has been a fun learning experience that led to this article.&lt;&#x2F;p&gt;
&lt;p&gt;Hope you find it informative‚Ä¶ And may the source be with you ü¶Ñ.&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;section-contents&quot;&gt;Section Contents&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;base64-decoding-a-string-in-go&#x2F;&quot;&gt;Base64 Decoding a String in Go&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;destructure&#x2F;&quot;&gt;Use Destructuring to Remove Attributes&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;getting-the-body-of-an-http-request-with-go&#x2F;&quot;&gt;Getting the Body of an HTTP Request With Go&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;lets-create-a-syslog-logger&#x2F;&quot;&gt;Let‚Äôs Create a Syslog Logger&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;make-your-code-leaner&#x2F;&quot;&gt;Make Your Code Leaner By Extracting Method&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;‚ñ∂ Who Else Wants to Have Their Own Mastodon Server?&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;microservice-env-vars&#x2F;&quot;&gt;How to Ensure Environment Variables Are Set&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;scaling-your-node-api-like-a-boss&#x2F;&quot;&gt;Scaling Your Node.js API Like a Boss&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;talkspiffe-stream-setup&#x2F;&quot;&gt;The Live Stream Dream&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;zshell-startup-files&#x2F;&quot;&gt;.zprofile, .zshrc, .zenv, OMG! What Do I Put Where?!&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;redirect-index-page&#x2F;&quot;&gt;Redirecting a Static Web Page&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;zerotohero.dev&#x2F;tips&#x2F;git-push-origin-main&#x2F;&quot;&gt;Understanding &lt;code&gt;git push origin main&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</content>
        
    </entry>
</feed>
