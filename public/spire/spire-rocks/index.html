<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><title>Setting Up SPIRE on EKS in Less Than Ten Minutes</title><meta content="architecture, development, hacker-culture" name=keywords><meta name=description><meta content="Volkan √ñz√ßelik" name=author><link href=https://zerotohero.dev/spire/spire-rocks/ rel=canonical><link href=https://zerotohero.dev/css/includes/scroll-bar.css rel=stylesheet><link href=https://zerotohero.dev/css/styles.css rel=stylesheet><link href=https://zerotohero.dev/css/override.css rel=stylesheet><link href=https://zerotohero.dev/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style> <style>@media (prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:#dadadb;--secondary:#9b9c9d;--tertiary:#414244;--content:#c4c4c5;--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><body id=top><script>if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }</script><script src=https://player.vimeo.com/api/player.js></script><header class=header><nav class=nav><div class=logo><a title="Zero to Hero (Alt + H)" accesskey=h href=https://zerotohero.dev> <svg viewbox="-0.5 -0.5 32 32" height=32 id=High-Voltage--Streamline-Kawaii-Emoji style=position:relative;top:2px;left:4px width=32 xmlns=http://www.w3.org/2000/svg><desc>High Voltage Streamline Emoji: https://streamlinehq.com</desc><path d="M16.244 18.21002a56.048 56.048 0 0 1 -8.1313 -0.8853599999999999 3.3480000000000003 3.3480000000000003 0 0 1 -2.3374 -4.7802C6.500699999999999 11.097999999999999 16.04994 3.35854 21.79548 1.2059a1.14328 1.14328 0 0 1 1.36772 1.68392c-1.2183 1.8599999999999999 -3.5340000000000003 4.0641 -7.88702 8.56716 1.98772 0.124 4.207319999999999 -0.093 6.55216 -0.07688a3.66172 3.66172 0 0 1 3.0534999999999997 1.3813600000000001c0.6975 0.9734 0.97898 2.33058 0.32674000000000003 3.3356 -1.54504 2.37894 -9.10284 9.4054 -13.52468 12.80362 -1.5741800000000001 1.2096200000000001 -2.7565199999999996 1.27596 -3.41 0.26226 -0.39742 -0.6169 0.18166 -1.32618 0.5251399999999999 -1.8258999999999999C10.185979999999999 25.320800000000002 16.182000000000002 18.20754 16.244 18.21002z" fill=#ffe500 stroke-width=1></path><path d="M24.881839999999997 12.76146a3.66172 3.66172 0 0 0 -3.0534999999999997 -1.3813600000000001 52.95544 52.95544 0 0 0 -1.9734599999999998 0.03038 3.472 3.472 0 0 1 2.54696 1.3509799999999998c0.6975 0.9734 0.9796 2.33058 0.32674000000000003 3.3356 -1.5444200000000001 2.37894 -9.10284 9.40478 -13.52468 12.80362a6.66996 6.66996 0 0 1 -0.744 0.496c0.682 0.75144 1.78498 0.6107 3.2209000000000003 -0.496 4.424939999999999 -3.3988400000000003 11.98336 -10.42468 13.52778 -12.80362 0.65286 -1.00502 0.37076 -2.3622 -0.32674000000000003 -3.3356zM20.6832 2.88982c-1.16498 1.77816 -3.3368399999999996 3.87314 -7.33026 7.9918000000000005a0.35773999999999995 0.35773999999999995 0 0 0 0.248 0.60698c0.65596 0.01302 1.33486 0 2.0292600000000003 -0.02294 -0.11656 -0.00496 -0.23994000000000001 0 -0.35525999999999996 -0.00868 4.34 -4.495 6.66066 -6.700340000000001 7.88082 -8.556000000000001a1.1457600000000001 1.1457600000000001 0 0 0 -1.35904 -1.69446c-0.3565 0.1333 -0.7285 0.28892 -1.11104 0.46252a1.09802 1.09802 0 0 1 -0.00248 1.22078z" fill=#f2c100 stroke-width=1></path><path d="M16.244 18.21002a56.048 56.048 0 0 1 -8.1313 -0.8853599999999999 3.3480000000000003 3.3480000000000003 0 0 1 -2.3374 -4.7802C6.500699999999999 11.097999999999999 16.04994 3.35854 21.79548 1.2059a1.14328 1.14328 0 0 1 1.36772 1.68392c-1.2183 1.8599999999999999 -3.5340000000000003 4.0641 -7.88702 8.56716 1.98772 0.124 4.207319999999999 -0.093 6.55216 -0.07688a3.66172 3.66172 0 0 1 3.0534999999999997 1.3813600000000001c0.6975 0.9734 0.97898 2.33058 0.32674000000000003 3.3356 -1.54504 2.37894 -9.10284 9.4054 -13.52468 12.80362 -1.5741800000000001 1.2096200000000001 -2.7565199999999996 1.27596 -3.41 0.26226 -0.39742 -0.6169 0.18166 -1.32618 0.5251399999999999 -1.8258999999999999C10.185979999999999 25.320800000000002 16.182000000000002 18.20754 16.244 18.21002z" fill=none stroke=#45413c stroke-linecap=round stroke-linejoin=round stroke-width=1></path></svg> Zero to Hero </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=/about title=About> <span>About</span> </a><li><a href=/archive title=Archive> <span>Archive</span> </a><li><a href=/tags title=Tags> <span>Tags</span> </a><li><a title="Vadideki Geyik" href=https://vadidekigeyik.com> <span>Vadideki Geyik</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a href=https://discord.gg/kampus title=kamp.us> <span>kamp.us</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a><li><a href=https://github.com/spiffe/spike title=SPIKE> <span>SPIKE</span> <svg viewbox="0 0 24 24" fill=none height=12 shape-rendering=geometricPrecision stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2.5 width=12><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zerotohero.dev>Home</a>¬†¬ª¬† <a href=https://zerotohero.dev/>Posts</a>¬†¬ª¬† <a href=https://zerotohero.dev/spire/spire-rocks/>Setting Up SPIRE on EKS in Less Than Ten Minutes</a></div><h1 class=post-title>Setting Up SPIRE on EKS in Less Than Ten Minutes</h1><div class=post-meta><span title="2021-12-18 00:00:00 +0000">2021-12-18</span>¬†¬∑¬†29 min¬†¬∑¬†Volkan √ñz√ßelik</div></header><div class=toc><details><summary title="(Alt + C)" accesskey=c><span class=details>Table of Contents</span></summary> <div class=inner><ul><li><a aria-label=Lecture href=#lecture>Lecture</a><li><a aria-label=Introduction href=#introduction>Introduction</a><li><a aria-label="What is a Workload?" href=#what-is-a-workload>What is a Workload?</a><li><a aria-label="‚ÄúHope‚Äù Is Not a Security Posture" href=#hope-is-not-a-security-posture>‚ÄúHope‚Äù Is Not a Security Posture</a><li><a aria-label="Zero Trust" href=#zero-trust>Zero Trust</a><li><a aria-label="The CIA Triad üï¥" href=#the-cia-triad-man-in-suit>The CIA Triad üï¥</a><li><a aria-label="X.509 Digital Certificates" href=#x-509-digital-certificates>X.509 Digital Certificates</a><li><a aria-label="Meet SPIFFE" href=#meet-spiffe>Meet SPIFFE</a><li><a aria-label="SPIFFE Key Elements" href=#spiffe-key-elements>SPIFFE Key Elements</a><li><a aria-label="Benefits of Using SPIFFE" href=#benefits-of-using-spiffe>Benefits of Using SPIFFE</a><li><a aria-label="Hello, SPIRE" href=#hello-spire>Hello, SPIRE</a><li><a aria-label="üïµÔ∏è‚Äç‚ôÄÔ∏è SPIRE Agents" href=#detectivefemale-spire-agents>üïµÔ∏è‚Äç‚ôÄÔ∏è SPIRE Agents</a><li><a aria-label="Registering a Workload" href=#registering-a-workload>Registering a Workload</a><li><a aria-label="üê¢ Secret Zero" href=#turtle-secret-zero>üê¢ Secret Zero</a><li><a aria-label="üê¢ It‚Äôs Secrets all the Way Down" href=#turtle-it-s-secrets-all-the-way-down>üê¢ It‚Äôs Secrets all the Way Down</a><li><a aria-label="üê¢ Solving the Bottom Turtle" href=#turtle-solving-the-bottom-turtle>üê¢ Solving the Bottom Turtle</a><li><a aria-label="The Shift of Trust" href=#the-shift-of-trust>The Shift of Trust</a><li><a aria-label="There‚Äôs No Spoon" href=#there-s-no-spoon>There‚Äôs No Spoon</a><li><a aria-label="Use Cases" href=#use-cases>Use Cases</a><li><a aria-label="Use The Source" href=#use-the-source>Use The Source</a><li><a aria-label="References and Further Reading" href=#references-and-further-reading>References and Further Reading</a> <ul><li><a aria-label="Kubernetes Concepts Covered in the Video" href=#kubernetes-concepts-covered-in-the-video>Kubernetes Concepts Covered in the Video</a><li><a aria-label="SPIFFE and SPIRE Fundamentals" href=#spiffe-and-spire-fundamentals>SPIFFE and SPIRE Fundamentals</a><li><a aria-label="Key Concepts" href=#key-concepts>Key Concepts</a><li><a aria-label="Algorithms and Standards" href=#algorithms-and-standards>Algorithms and Standards</a><li><a aria-label="Related Technologies" href=#related-technologies>Related Technologies</a></ul><li><a aria-label="Key Terms" href=#key-terms>Key Terms</a> <ul><li><a aria-label="Zero Trust" href=#zero-trust-1>Zero Trust</a><li><a aria-label=Authentication href=#authentication>Authentication</a><li><a aria-label=Authorization href=#authorization>Authorization</a><li><a aria-label=Node/Worker href=#node-worker>Node/Worker</a><li><a aria-label=Workload href=#workload>Workload</a><li><a aria-label=Attestation href=#attestation>Attestation</a><li><a aria-label="SPIFFE ID" href=#spiffe-id>SPIFFE ID</a><li><a aria-label="SVID (SPIFFE Verifiable Identity Document)" href=#svid-spiffe-verifiable-identity-document>SVID (SPIFFE Verifiable Identity Document)</a><li><a aria-label="Trust Bootstrap" href=#trust-bootstrap>Trust Bootstrap</a><li><a aria-label="Trust Domain" href=#trust-domain>Trust Domain</a><li><a aria-label="Root of Trust" href=#root-of-trust>Root of Trust</a><li><a aria-label=Signing href=#signing>Signing</a><li><a aria-label="Mutual TLS (mTLS)" href=#mutual-tls-mtls>Mutual TLS (mTLS)</a><li><a aria-label="Public-key cryptography (asymmetric cryptography)" href=#public-key-cryptography-asymmetric-cryptography>Public-key cryptography (asymmetric cryptography)</a><li><a aria-label="PKI (Public Key Infrastructure)" href=#pki-public-key-infrastructure>PKI (Public Key Infrastructure)</a><li><a aria-label=X.509 href=#x-509>X.509</a><li><a aria-label=X509-SVID href=#x509-svid>X509-SVID</a><li><a aria-label=Kernel href=#kernel>Kernel</a><li><a aria-label=Hardening href=#hardening>Hardening</a><li><a aria-label="Hardware Security Module (HSM)" href=#hardware-security-module-hsm>Hardware Security Module (HSM)</a><li><a aria-label="Key Management Service (KMS)" href=#key-management-service-kms>Key Management Service (KMS)</a></ul><li><a aria-label=Conclusion href=#conclusion>Conclusion</a><li><a aria-label="Section Contents" href=#section-contents>Section Contents</a></ul></div></details></div><div class=post-content><p><img alt="Setting Up SPIRE on EKS in Less Than Ten Minutes" src=/images/size/w1200/2024/03/trust.png><p>Psst‚Ä¶ üîé Looking for <strong>GopherCon, 2021, TR</strong> resources? Say no more:<ul><li>GopherCon TR, Dec, 2021: <em>Friends Don‚Äôt Let Friends Hard-Code Their Secrets</em> <ul><li>‚ú¥Ô∏è <a href=https://assets.zerotohero.dev/gophercon-tr-dec-2021/SPIRE-gophercon-TR-Dec-2021.pdf><strong>Slides</strong></a><li>‚ú¥Ô∏è <a href=https://assets.zerotohero.dev/gophercon-tr-dec-2021/SPIRE-gophercon-TR-Dec-2021-src.zip><strong>Source Code</strong></a></ul></ul><p>Here is a video recording of the demo we made too:<div style="padding:56.25% 0 0;position:relative"><iframe allow="accelerometer; autoplay; clipboard-write; 
    encrypted-media; gyroscope; picture-in-picture; web-share" src="https://www.youtube.com/embed/n-hXWL5BgHg?si=ymLdQTIJlid0v8QH" title="mTLS Using Spire Under Three Minutes" allowfullscreen frameborder=0 referrerpolicy=strict-origin-when-cross-origin style=width:100%;height:100%;position:absolute;top:0;left:0></iframe></div><p style=text-align:center>mTLS Using Spire Under Three Minutes<p>Make sure you watch the longer video below, and read the rest of the article too.<p>Enjoy, and may the source be with you ü¶Ñ.<blockquote><p><strong>‚ö†Ô∏è Important ‚ö†Ô∏è</strong><p>If you are new to <a href=https://spiffe.io/><strong>SPIFFE</strong></a> and <a href=https://spiffe.io/downloads/><strong>SPIRE</strong></a>, <strong>read the rest of the article first</strong> before watching the video.</blockquote><h2 id=lecture>Lecture</h2><div style="padding:56.25% 0 0;position:relative"><iframe allow="accelerometer; autoplay; clipboard-write; 
    encrypted-media; gyroscope; picture-in-picture; web-share" src="https://www.youtube.com/embed/FUDsXgrnI2c?si=TAvLj-iXXmDDQWg0" title="Setting Up SPIRE on EKS in Less Than Ten Minutes" allowfullscreen frameborder=0 referrerpolicy=strict-origin-when-cross-origin style=width:100%;height:100%;position:absolute;top:0;left:0></iframe></div><p style=text-align:center>Setting Up SPIRE on EKS in Less Than Ten Minutes<h2 id=introduction>Introduction</h2><p>This article will look at what <strong>SPIFFE</strong> and <strong>SPIRE</strong> are. Then, we‚Äôll explore why managing identities and <strong>Trust</strong> at scale is a tough challenge and how to solve it in a repeatable, scalable, and platform-agnostic way.<div class=z2h-image><p class=img><img alt="SPIFFE and SPIRE Logos" src=/images/2021/10/spiffe-spire-logo-small.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>SPIFFE and SPIRE Logos</div><p>In the video that accompanies this article, you‚Äôll see how you can configure <strong>SPIRE</strong> on an <strong>AWS EKS</strong> Kubernetes cluster. Then we‚Äôll ensure that it can fetch <strong>SPIFFE ID</strong> documents (<em>or <strong>SVID</strong>s</em>) from the <strong>SPIRE Server</strong>.<p><strong>SVID</strong>s, which stand for <em>SPIFFE verifiable identity document</em>, are specially-crafted <strong>X.509 Certificates</strong> that the <strong>Workloads</strong> can use to authenticate with each other.<blockquote><p>**SVIDs Rotate Automatically<p>SVID**s are short-lived, their lifetime is 1 hour by default, and they are renewed every 30 minutes so that you don‚Äôt run out of SVIDs due to TTL.</blockquote><p>But before going any further, it‚Äôs better to clarify all this buzzword bingo‚ÄîI mean, what is a ‚Äú<strong>workload</strong>‚Äù?‚Äîwhat the heck is and <strong>SVID</strong>? Why do we even need it? Can we eat it üòÅ?<h2 id=what-is-a-workload>What is a Workload?</h2><p>Let‚Äôs start with something familiar: The <strong>workload</strong>.<p>A <strong>workload</strong>, in the context of <strong>SPIFFE</strong> and <strong>SPIRE</strong>, is anything that does a computation.<blockquote><p><strong>Portable and Platform-Agnostic</strong><p>In Cloud-Native terms, a <strong>workload</strong> is an integrated stack of application, middleware, and operating system that accomplishes a computing task. A workload is <strong>portable</strong> and <strong>platform-agnostic</strong>. A workload, or a collection of workloads makes up a <strong>business service</strong>.</blockquote><p>Let us take the project that we have been developing so far, for example. In that case, the <strong>idm</strong>, <strong>crypto</strong>, <strong>mailer</strong>, <strong>questions</strong>, and <strong>store</strong> pods that expose RESTful APIs in our Kubernetes cluster are all <strong>workload</strong>s.<pre class=language-bash data-lang=bash style=color:#fdf4c1aa;background-color:#282828><code class=language-bash data-lang=bash><span style=color:#fdf4c1>‚ûú  ~ kubectl get po
</span><span style=color:#fdf4c1>NAME                         READY   STATUS    RESTARTS   AGE
</span><span style=color:#fdf4c1>client-649db6b744-g85wb      1/1     Running   0          23d
</span><span style=color:#fdf4c1>crypto-66d75ccdbf-k2khl      1/1     Running   0          31d
</span><span style=color:#fdf4c1>idm-b9497f654-r7qg6          1/1     Running   0          31d
</span><span style=color:#fdf4c1>mailer-6d5c745b87-nz9dt      1/1     Running   0          31d
</span><span style=color:#fdf4c1>questions-67d5559dd9-dglc6   1/1     Running   0          31d
</span><span style=color:#fdf4c1>store-74bd85799b-w5xx9       1/1     Running   0          31d
</span></code></pre><p>Pods in our FizzBuzz Pro production cluster.<p>Workloads will often need to communicate; they must send API requests to different downstream workloads and receive API responses.<div class=z2h-image><p class=img><img alt="FizzBuzz Pro email verification flow." src=/images/2021/10/Screen-Shot-2021-10-09-at-7.27.39-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>FizzBuzz Pro email verification flow.</div><p>In the above sequence diagram, the <strong>idm</strong> workload talks to the <strong>crypto</strong> workload to get a verification token. Then, the <strong>idm</strong> workload talks to the * <em>mailer</em>* workload to relay that token in an email message.<blockquote><p><strong>Workload == Service</strong><p>One more thing before I move further: In this article, and also in the video that accompanies this article, I use the terms <strong>workloads</strong> and <strong>services</strong> interchangeably. Our microservices <strong>are</strong> our workloads, don‚Äôt get confused.</blockquote><p>Within the context of this article, a <strong>workload</strong> or <strong>service</strong> is a process that lives on a physical or virtual machine and does some form of meaningful computation. Workloads often communicate and exchange information through protocols like <strong>RESTful API</strong>s, <strong>protocol buffers</strong>, <strong>domain sockets</strong>, or other inter-process communication mechanisms.<h2 id=hope-is-not-a-security-posture>‚Äú<em>Hope</em>‚Äù Is Not a Security Posture</h2><p>The problem is, how do we <strong>secure</strong> this communication channel between the workloads that we have?<p>One way to take care of this is to create a large enough <strong>trust boundary</strong> to know that the network is trusted. Then you <strong>hope</strong> no malicious parties can get inside this secured zone to attack your services.<div class=z2h-image><p class=img><img alt="A subset of FizzBuzz Pro microservices' network boundaries." src=/images/2021/10/network.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>A subset of FizzBuzz Pro microservices' network boundaries.</div><p>If we look into the above network boundary diagram, the <strong>mailer</strong> and **crypto ** services are inside a private network; they don‚Äôt expose any public APIs. We <strong>hope</strong> this could be enough to secure them.<p><strong>Hope</strong> is not the best strategy in terms of hardening your security posture. I won‚Äôt dive into too much detail in this article, and there are so many ways * <em>hope</em>* as a security strategy can go wrong.<p>To give a single example, though, assume we have another pod here (<em>see the diagram below</em>). This pod is a <strong>web-ui</strong> pod that has nothing to do with mailer and crypto. Therefore, it should not know about these services and not care that they exist at all.<div class=z2h-image><p class=img><img alt="A brand new web UI pod, reaching larger parts of the network than it should." src=/images/2021/10/Screen-Shot-2021-10-09-at-8.11.10-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>A brand new web UI pod, reaching larger parts of the network than it should.</div><p>Can you <strong>hope</strong> that this service will not start talking to the crypto service, generate random tokens? Can you ensure there isn‚Äôt a vulnerability in a dependency that it uses? How about <em>a dependency of a dependency of a dependency‚Ä¶ üê¢</em>? Can you be sure that the code is free of <em>logic errors</em>? Can you be sure that the pod will not start acting weirdly all of a sudden?<div class=z2h-image><p class=img><img alt="This is why code reviews are a good thing." src=/images/2021/10/code-reviews.jpeg><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>This is why code reviews are a good thing.</div><p>Can you <strong>hope</strong> that nothing like this could happen?<p><strong>Hope</strong> is <strong>not</strong> a strategy. Instead, it would be best if you hardened the communication between these workloads. That way, only the intended parties could talk to each other. No one else in the network could manipulate this communication.<h2 id=zero-trust>Zero Trust</h2><p>That‚Äôs where the concept of <strong>Zero Trust</strong> comes into play. Again, you can learn more about it in the <strong>References and Further Reading</strong> section at the end of this article, but in essence, <strong>Zero Trust</strong> means that <em>you cannot trust the network</em>. Therefore, you should assume that your network is insecure and is breached by default.<p><strong>Zero Trust</strong> is a network security model based on a strict identity verification process. The <a href=https://en.wikipedia.org/wiki/Zero_trust_security_model><em><strong>Zero Trust</strong> Security Model</em></a> dictates that only authenticated and authorized workloads can talk to other <strong>authenticated</strong> and <strong>authorized</strong> workloads.<p>Here are some of the key motivations behind the <a href=https://en.wikipedia.org/wiki/Zero_trust_security_model><em><strong>Zero Trust</strong> Security Model</em></a>:<ul><li>Users, devices, applications, and data are moving outside trust boundaries all the time. Now it‚Äôs near impossible to do perimeter-based protection.<li>‚Äú<em>Trust but verify</em>‚Äù is no longer an option, as targeted, advanced threats constantly move inside the corporate perimeter.<li>The network has become a complex mess with the introduction of cloud apps and the Internet of Things. The increased risk is not compatible with traditional access-control-list-oriented network security models.</ul><h2 id=the-cia-triad-man-in-suit>The CIA Triad üï¥</h2><p>Then, the question reduces to ‚Äú<em>how do we ensure workload-to-workload communication where the network is untrustworthy?</em>‚Äù.<p>So how do we secure service-to-service communication then?<p>This puzzle has three parts to solve, also known as the <strong>CIA</strong> Triad: * <em>Confidentiality</em>*, <strong>Authenticity</strong>, and <strong>Integrity</strong>.<p><strong>Confidentiality</strong>: The workload-to-workload communication should be on a secure channel that no one else can listen to.<p><strong>Integrity</strong>: The message that is being sent from one workload has not been tampered with. The data is complete, accurate, and hasn‚Äôt been altered by anyone else.<p><strong>Authenticity</strong>: The sender of the data is the workload who claims it is. It is not some other service that‚Äôs trying to impersonate the original service.<div class=z2h-image><p class=img><img alt="The CIA triad." src=/images/2021/10/cia-triad.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>The CIA triad.</div><h2 id=x-509-digital-certificates>X.509 Digital Certificates</h2><p>There are well-established, industry-standard ways of solving the puzzle. We can establish <strong>confidentiality</strong>, verify <strong>integrity</strong>, and ensure <strong>authenticity</strong> in an industry-standard way.<p>The most common way is to use asymmetric cryptography and <a href=https://en.wikipedia.org/wiki/X.509><strong>X.509 Digital Certificates</strong></a>. Again, I‚Äôm not going into too much detail about certificates and certificate chains. Check out the reference material at the end of this article for a deeper drill-down on the subject matter.<p>For the context of this article, we need to know that when two workloads have each other‚Äôs <strong>X.509</strong> public keys, they can establish a secure communication channel. Then, they can talk to each other through this secure communication channel.<p>Moreover, they can prove the message‚Äôs authenticity and integrity by digitally signing the message with their private key.<p>Finally, they can ensure the confidentiality of the communication channel by encrypting the payload with the receiver‚Äôs public key.<p>How these mechanisms work varies by the algorithm and implementation, and it‚Äôs a bit more involved than the quick summary outlined above. Suppose we sacrifice a little bit of rigor for clarity. In that case, we can say that when you have your <em>Certificates of Trust</em>, you can ensure <strong>confidentiality</strong>, <strong>integrity</strong>, and <strong>authenticity</strong> in your <strong>workload-to-workload communications</strong>.<h2 id=meet-spiffe>Meet <strong>SPIFFE</strong></h2><p>The following outstanding question is: ‚Äú<em>Since they are so helpful, how do we create these <strong>X.509</strong> Certificates?</em>‚Äù<p>Other questions one might wonder are:<ul><li>Since these certificates ensure secure service-to-service communication, it‚Äôs a good idea to rotate them frequently. How do we do that?<li>And also, it‚Äôs a good idea to invalidate them if some of these certificates leak. How can we do it?<li>Also, how do we optimize and automate the process the certificate rotation and expiration?</ul><p>Why automate? Because <strong>security and humans do not mix well together</strong>. So we better <strong>automate</strong> this entire certificate generation, rotation, revocation, and invalidation process <strong>without needing any human intervention</strong>.<p>That‚Äôs where <strong>SPIFFE</strong> comes into play.<p><strong>SPIFFE</strong>, <em>the Secure Production Identity Framework For Everyone</em>, provides a <strong>secure identity</strong>, in the form of a specially crafted <strong>x.509 certificate</strong>, to every workload in your production environment.<blockquote><p><strong>Short-Lived Keys</strong><p>The heart of the <strong>SPIFFE</strong> specifications is the one that defines short-lived cryptographic identity documents ‚Äì called <strong>SVID</strong>s via a simple API. Workloads can then use these identity documents when authenticating to other workloads.</blockquote><p><strong>SPIFFE</strong> is a set of <strong>open-source specifications</strong> for a framework capable of <strong>bootstrapping</strong> and issuing <strong>identity</strong> to services anywhere without depending on any specific platform.<blockquote><p><strong>There Are</strong> <strong>JWT SVIDs, Too</strong><p>There are other ways <strong>SPIFFE</strong> provides identity documents too, but in this article, we‚Äôll talk about <strong>X.509</strong> identities only. More specifically, <strong>X.509 SPIFFE Verifiable Identity documents</strong> or <strong>SVIDs</strong>.</blockquote><h2 id=spiffe-key-elements><strong>SPIFFE</strong> Key Elements</h2><p><strong>SPIFFE</strong> has the following key components:<ul><li>The <strong>SPIFFE ID</strong>, how a software service‚Äôs <strong>name</strong> (<em>or <strong>identity</strong></em>) is represented.<li>The <strong>SPIFFE Verifiable Identity Document</strong> (<strong><em>SVID</em></strong>), a cryptographically verifiable document used to prove a service‚Äôs identity to a peer.<li>The <strong>SPIFFE Workload API</strong>, a simple node-local API that services use to obtain their identities without the need for authentication.<li>The <strong>SPIFFE Trust Bundle</strong>, a format for representing the collection of public keys in use by a given <strong>SPIFFE</strong> issuing authority.<li><strong>SPIFFE Federation</strong>, a simple mechanism by which <em><strong>SPIFFE</strong> Trust Bundles</em> can be shared.</ul><h2 id=benefits-of-using-spiffe>Benefits of Using <strong>SPIFFE</strong></h2><p>By using <strong>SPIFFE</strong>, you won‚Äôt need to maintain application-level authentication information.<blockquote><p><strong>No Tokens, No Problem</strong><p>Think about it. That‚Äôs something <strong>BIG</strong>:<br> You won‚Äôt need a unique secret service key or a special token for your workload to prove its identity anymore.</blockquote><p>In addition, <strong>SPIFFE</strong> is a platform-agnostic standard, so you avoid vendor lock-in by using it across your clusters.<p>And since <strong>SPIFFE</strong> is an open standard, you can interact with any application or service that supports <strong>SPIFFE</strong> without having to modify your codebase or your application configuration.<p>Moreover, <strong>SPIFFE</strong> solves the automating the credential creation problem that we mentioned before. It is an open standard that establishes how these <strong>SVID x.509 Certificates</strong> are <strong>created</strong>, <strong>defined</strong>, <strong>rotated</strong>, <strong>verified</strong>, and <strong>invalidated</strong> automatically without needing human intervention.<blockquote><p><strong>Caching and Performance</strong><p>The workloads periodically receive updated identity documents (i.e., <strong>SVID</strong> s) as certificates expire or the configuration changes. The <strong>SPIRE</strong> agent * <em>preloads</em>* the identities for all workloads it may host. This preload operation minimizes the impact of server downtime on the availability of the Workload API.</blockquote><p>In addition to all these, you won‚Äôt have to assume that your network is secure because the <strong>SVID</strong>s will ensure the security and integrity of service-to-service communication that the services have.<p>That‚Äôs a great advantage because maintaining network access control list and firewall rules is <strong>cumbersome</strong>. It is prone to <strong>human errors</strong>, time-consuming, and <strong>impractical</strong> when your network boundaries and the network overlays you use change all the time.<h2 id=hello-spire>Hello, <strong>SPIRE</strong></h2><p>Okay, that was <strong>SPIFFE</strong>. But, what is <a href=https://spiffe.io/docs/latest/spire-about/spire-concepts/><strong>SPIRE</strong></a>?<p>{{img( src=‚Äú/images/2021/10/keymaker.png‚Äù, alt=‚ÄúSPIFFE defines how to make keys; SPIRE is the key maker.‚Äù )}<blockquote><p><strong>About SPIRE</strong><p>If <strong>SPIFFE</strong> is a set of standards, what implements those standards? That‚Äôs where <strong>SPIRE</strong> comes into play.</blockquote><p><strong>SPIRE</strong> is a production-ready reference implementation of <strong>SPIFFE</strong>.<p><strong>SPIRE</strong> does its job by <a href=https://spiffe.io/docs/latest/spire-about/spire-concepts/#workload-attestation>performing <strong>node</strong> and <strong>workload</strong> <strong>attestation</strong></a>. This way, it reliably and securely identifies workloads and issues them <strong>SVID</strong> s (<em>SPIFFE Verfifiables IDs</em>), which are nothing but specialized <em>X.509 Certificates</em>. The workloads, then, can use them to prove their identity.<div class=z2h-image><p class=img><img alt="Workload attestation." src=/images/2021/10/attestation.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Workload attestation.</div><p>You‚Äôll see an example of how this attestation flow works in the video I‚Äôve added to the beginning of this article.<p>If you want a quick summary, workload attestation is a process where the <strong>SPIRE</strong> agent relies on locally trusted workload attributes. These attributes can be as process/group ID or container runtime metadata. Some examples of these metadata include the pod names, namespaces, service accounts, and the like.<p>After all, if our cluster‚Äôs <strong>Kubernetes API</strong> can <strong>attest</strong> that our workload pod has a particular <strong>name</strong>, with certain <strong>tags</strong>, managed by a specific * <em>service account</em>*, in a given <strong>namespace</strong>, in a known <strong>cluster</strong>‚Ä¶ that is enough information to identify this workload.<p>This way, the workload will not need to provide a secret key to prove its authenticity. Instead, we shift the trust and responsibility of establishing the workload‚Äôs authenticity to the orchestration framework (<em><strong>Kubernetes</strong> in this case</em>). By talking to Kubernetes APIs, we can verify, with confidence, that this workload pod is what it claims it is.<blockquote><p><strong>Node and Workload Registration</strong><p>One thing that I‚Äôve been conveniently hiding so far, is, you have to * <em>register</em>* nodes and workloads before you can attest them. For the interested, this document outlines the details of <a href=https://spiffe.io/docs/latest/deploying/registering/>how workloads are registered with <strong>SPIFFE</strong> IDs in the <strong>SPIRE</strong> server</a>.</blockquote><h2 id=detectivefemale-spire-agents>üïµÔ∏è‚Äç‚ôÄÔ∏è SPIRE Agents</h2><p>There is a single <strong>SPIRE</strong> <strong>Agent</strong> on each <strong>Node</strong>. The agents talk to the <strong>SPIRE Server</strong>. Multiple workloads on the node talk to the same agent using the <strong>SPIFFE Workload API</strong> to receive their <strong>SVID</strong>s.<div class=z2h-image><p class=img><img alt="SPIRE Server and Agent architecture." src=/images/2021/10/server_and_agent.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>SPIRE Server and Agent architecture.</div><h2 id=registering-a-workload>Registering a Workload</h2><p>For <strong>workloads</strong> to receive <strong>SVID</strong>s, they need to be <strong>registered</strong> first.<p>There are several ways to register a workload: Either an operator registers your workloads to the <strong>SPIRE</strong> server, and then the operator manually provisions the workloads. Or you can automate this step entirely in your <strong>CI Pipeline</strong>: Your <strong>CI/CD</strong> orchestration tool can <strong>register</strong> the workloads to the <strong>SPIRE Server</strong> and <strong>deploy</strong> them to your cluster.<blockquote><p><strong>You Define Your Attestors During Registration</strong><p>The <strong>Workload Registration</strong> step is also where you specify your workload attestors to the SPIRE server. Then the <strong>SPIRE Agent</strong> will use those attestors to assign an identity to your workload and assign them <strong>SVID</strong>s.</blockquote><p>After the workoad registration is complete, workloads will bind to the spire agent‚Äôs <a href=https://en.wikipedia.org/wiki/Unix_domain_socket><strong>domain socket</strong></a> and regularly fetch <strong>SVID</strong>s.<p>And that‚Äôs all about it. After a successful registration, <strong>SPIRE</strong> takes care of the certificate initialization, assignment, revocation, and rotation problems when everything is set up, each of which is hard to solve individually.<blockquote><p><strong>go-spiffe</strong><p><a href=https://github.com/spiffe/go-spiffe><strong>go-spiffe</strong></a> is a library that can make the ‚Äúfetching <strong>SVID</strong>s from the <strong>SPIRE Agent</strong>‚Äù part much painless (<em>among other abstractions</em>).</blockquote><h2 id=turtle-secret-zero>üê¢ Secret Zero</h2><p>What makes <strong>SPIFFE</strong> stand out is that it solves what‚Äôs called the ‚Äú<strong><em>secret zero</em></strong>‚Äù problem. In a nutshell, the problem statement goes as follows:<ul><li>Enabling access control to service requires a secret such as an API key or password.<li>That key or password needs to be protected, so you encrypt the key.<li>But then you have to watch the decryption key that you‚Äôll use to get your service key back.<li>So you put the decryption key to a Keystore.<li>But then you‚Äôll have to protect the Keystore‚Äôs master key.</ul><p>And this goes on and on. Ultimately, protecting access to one secret results in a new secret you need to save.<p>Which begs the following question: ‚Äú<em>Who protects the <strong>secret zero</strong>‚Äîthe ultimate secret‚Äîthat gives the keys to the entire kingdom?</em>‚Äù.<p>Rest assured, we‚Äôll get there. Just üêª with me for a while.<h2 id=turtle-it-s-secrets-all-the-way-down>üê¢ It‚Äôs Secrets all the Way Down</h2><p><strong>Identity</strong> and <strong>Authentication</strong> go hand-in-hand. Claiming an identity is useless unless you can <strong>authenticate</strong> that identity and <strong>prove</strong> with confidence that the identity is indeed what it claims to be.<div class=z2h-image><p class=img><img alt="Turtles all the way down." src=/images/2021/10/turtles.jpeg><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>Turtles all the way down.</div><p>One way to authenticate an identity is to provide a secret key or a password along with the identity. Then a second independent identity management service can verify this identity. In certain other implementations, services can use hard-coded secret service keys to identify themselves.<p>In either case, to prove the identity, you need a <strong>secret</strong>. But this secret is <strong>vital</strong> because if an attacker gets a hold of this secret, they can authenticate as the service holding the secret.<blockquote><p><strong>Do Not Hard-Code Your Secrets</strong><p>That‚Äôs why hard-coding the secret inside the source code or baking it on a virtual machine image such as an AWS AMI is not a good idea.<p>Also, although the <a href=https://12factor.net/>Twelve Factor App Methodology</a> encourages it, storing secrets in the workload as environment variables can cause security problems (especially, in form of leaked environment variables inside the aggregated log streams)‚ÄîApps should ideally keep their secrets in <strong>temporary</strong> memory-mounted volumes.</blockquote><p>A better way is to put the secret into a <strong>Keystore</strong>, let the service authenticate with the secret store, and let the service get it from the key store.<p>A third-party orchestration system can authenticate with the Keystore by unlocking the Keystore using the Keystore‚Äôs master key. Then it can fetch the secret key that the service will use. Then inject it as a read-only, in-memory configuration volume to the service and then lock the Keystore so that no one else can reach it.<p>But then, how do we protect the Keystore‚Äôs master key? Because if an evil attacker gets it from our orchestration system somehow, then we are at square zero; they will get all the keys to all the services.<p><a href=https://www.vaultproject.io/>HashiCorp <strong>Vault</strong></a>, for example, attempts to solve this problem using <a href=https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing><strong>Shamir‚Äôs Secret Sharing Algorithm</strong></a>.<p><strong>Vault</strong> splits the key into three or more parts; if you don‚Äôt provide either all the parts or the majority of the parts (<em>depending on how you set up Vault</em>), Vault will not unlock.<p>So it makes getting the key harder, but still, it‚Äôs just pushing the problem one level down, not entirely solving it.<p>No matter how hard it is, if you get the three master keys from wherever they are stored, you can generate what Vault calls the ‚Äú<strong><em>unseal key</em></strong>.‚Äù Then, you gain access to the entire kingdom again.<p>To add more security, you can use Vault‚Äôs ‚Äú<em><strong>auto unseal</strong></em>‚Äù feature and delegate the providing and rotating of the unseal key to a <em>bare metal</em> or *cloud_ <strong>HSM</strong>. But now, you‚Äôll need to protect the HSM‚Äôs master key because reaching it will give access to Vault‚Äôs unseal key, which will provide access to all of your service secret keys.<h2 id=turtle-solving-the-bottom-turtle>üê¢ Solving the Bottom Turtle</h2><p>Do you see the issue here?<p>Managing secrets at scale requires effective <strong>access control</strong>; implementing access control requires <strong>validating identity</strong>. That‚Äôs because without providing a valid identity, it will be ‚Äú<em>public access</em>,‚Äù which defeats the entire purpose of using secret keys in the first place. Yet, proving identity requires possession of <strong>yet another secret</strong>‚ÄîThat‚Äôs akin to stacking one turtle atop another. It‚Äôs <strong>turtles all the way down</strong> üê¢.<div class=z2h-image><p class=img><img alt="A turtle in the bottom of the ocean (a 'bottom turtle'?)." src=/images/2021/10/turtle-1.jpeg><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>A turtle in the bottom of the ocean (a 'bottom turtle'?).</div><blockquote><p>üê¢ <strong>Turtles All the Way Down</strong><p><em>‚Äú<strong>Turtles all the way down</strong>‚Äù</em> is an expression of the problem of infinite recursion. The saying alludes to the mythological idea of a World Turtle that supports a flat earth on its back. It suggests that this turtle rests on the back of an even larger turtle, which itself is part of a column of increasingly large turtles that continues ad infinitum.</blockquote><p>Protecting one secret requires coming up with some way to protect another secret, which then requires protecting that secret, and so on.<p>That‚Äôs why improperly designed secrets management solutions have a master key that unlocks everything. All a hacker needs to do is either steal or guess this one master password to access everything. This master password is <strong>secret zero</strong>.<p>This approach is equivalent to locking all of your keys in a drawer and then putting the key of the drawer under the flower pot in your backyard‚Äîdon‚Äôt do that üôÉ.<p>To break this loop, we need to find a <strong><em>bottom turtle</em></strong>, that is, some secret that provides access to the rest of the secrets we need for authentication and access control.<p>The next section is about how to find the <strong>bottom turtle</strong>.<h2 id=the-shift-of-trust>The Shift of Trust</h2><p>A better solution to <strong>secret zero</strong> is a tad counterintuitive:<blockquote><p><strong>What If I Told You‚Ä¶</strong><br> Instead of securing the secret zero, what if we didn‚Äôt use any secret at all?</blockquote><p>As it happens, we can avoid the <strong>secret zero</strong> problems entirely by leveraging <strong>authenticators</strong> that work with the <strong>underlying infrastructure</strong> to authenticate the access to your secrets.<div class=z2h-image><p class=img><img alt="No secrets, no problem." src=/images/2021/10/Screen-Shot-2021-10-09-at-8.49.47-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>No secrets, no problem.</div><p>In <strong>SPIRE</strong>, this authentication process is called <strong>attestation</strong>. You <strong>attest</strong> both the <strong>nodes</strong> and also the <strong>workloads</strong>.<blockquote><p>**What are Nodes?<p>Nodes** are virtual or physical machines, and <strong>workloads</strong> are processes running on these nodes either directly or inside a container in a pod.</blockquote><p>To verify that a workload is authorized for a particular identity, <a href=https://spiffe.io/docs/latest/spire-about/spire-concepts/#workload-attestation>the <strong>SPIRE</strong> agent performs <strong>workload attestation</strong></a>. During <strong>workload attestation</strong>, workload‚Äôs attributes are read from the kernel or other trusted components on the local system. Then, the <strong>SPIRE</strong> agent matches the attributes against configured identities and provides each workload with all the identities for which it is authorized.<blockquote><p><strong>Two Workloads Can Share the Same ID</strong><p>Note that workload-identity association is a many-to-many relationship: A workload may be authorized for zero or more identities. Similarly, zero or more workloads can be associated with a single identity.</blockquote><p>For example, if the Kubernetes <strong>api-server</strong> can verify that your pod has a name <strong>idm</strong>, living inside a cluster named <strong>fizz-cluster</strong> using a service account named <strong>fizz-sa</strong> under a namespace <strong>fizz</strong>; that is adequate identifying information to <strong>prove</strong> the identity of the <strong>idm</strong> pod with confidence. So even if the pod does not provide any secret, the <strong>SPIRE</strong> <strong>workload attestor</strong> plugin can verify the identity of the idm pod by talking to Kubernetes APIs.<blockquote><p><strong>Root of Trust</strong><p>During the workload <strong>attestation</strong> process (<em>as exemplified above</em>), <strong>SPIRE</strong> establishes a <strong>Root of Trust</strong>. It builds an automated solution around workload identity. This identity then forms the foundation for all the interactions that require authentication and authorization.</blockquote><h2 id=there-s-no-spoon>There‚Äôs No Spoon</h2><p>In other words, when you use <strong>SPIRE</strong>, you shift the burden of trust from the Keystore to the operating system‚Äôs kernel, the cloud provider APIs, the orchestration framework, or to a mixture of all of these.<p>It‚Äôs a good time to re-intruduce the <strong><em>SPIRE workload attestation</em></strong> diagram. Pay attention to how the <strong>workload attestor</strong> uses different plugins to use * <em>kubelet</em>* for Kubernetes-native workloads, and the linux <strong>kernel</strong> for other workloads. <a href=https://spiffe.io/docs/latest/planning/extending/>This <strong>plugin-based</strong> architecture</a> is one of the reasons why <strong>SPIRE</strong> is so easy to extend.<p><img alt="SPIRE workload attestation." src=/images/2021/10/attestation-1.png><p>How the <strong>SPIRE</strong> workload attestation works is‚Äîat a very high/conceptual level‚Äîsimilar to how the <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html><em><strong>AWS Instance Metadata</strong> API</em></a> works or how the instance metadata API of any other cloud provider functions.<p>In a similar fashion to the <em>AWS Instance Metadata API</em>, the <a href=https://spiffe.io/docs/latest/spire-about/spire-concepts/#workload-registration><strong>SPIRE</strong> <strong>Workload API</strong></a> does not require that a calling workload have any knowledge of its own identity or possess any authentication token when calling the API. Using the Instance Metadata API means your application does not need not co-deploy any authentication secrets with the workload:<p><strong>There‚Äôs no spoon</strong>.<div class=z2h-image><p class=img><img alt="SPIRE workload attestation." src=/images/2021/10/Screen-Shot-2021-10-09-at-9.07.00-AM.png><p class=alt style=text-align:center;margin-top:-1.125em;font-size:1em;font-style:italic>SPIRE workload attestation.</div><p>Unlike these other APIs, however, the <strong>SPIRE</strong> Workload API is <strong>platform-agnostic</strong>. In addition, it can identify running services at the <strong>process level</strong> and <strong>kernel level</strong>, making it suitable for use with container schedulers such as <strong>Kubernetes</strong>.<p>Having learned the basics of <strong>SPIFFE</strong> and <strong>SPIRE</strong>, let‚Äôs look at some use cases from companies that use <strong>SPIFFE</strong> on scale production.<h2 id=use-cases>Use Cases</h2><p>Here are some examples of real-life use cases that talk about <strong>SPIFFE</strong> and <strong>SPIRE</strong> out in the wild.<ul><li><a href="https://www.youtube.com/watch?v=o98SFmW4akQ">Using <strong>SPIRE</strong> in Production at Uber</a><li><a href=https://www.crowdcast.io/e/pin-spiffe>Overcoming the identity crisis at Pinterest with <strong>SPIFFE</strong></a><li><a href=https://youtu.be/x642wq7lbpY>10 Lessons From Migrating to <strong>SPIFFE</strong> After 10 Years Of Service Identity at Square</a><li><a href=https://youtu.be/nZXCbiS6wfE>Passport App: The role of <strong>SPIFFE</strong> and <strong>SPIRE</strong> in return to work solution</a><li><a href=https://youtu.be/vX8SS5wQuY8><strong>SPIFFE</strong> at GitHub</a><li><a href=https://youtu.be/4pfY0uFW7yk>Securing Kafka with <strong>SPIFFE</strong></a><li><a href="https://youtu.be/xgzQEb9hbMI?t=222">Attesting Istio Workload Identities with <strong>SPIRE</strong></a><li><a href="https://youtu.be/xgzQEb9hbMI?t=1606">Parsec and <strong>SPIFFE</strong></a><li><a href="https://www.youtube.com/watch?v=eCLTdSp4JzE">Cloud-Native Identity Management</a><li><a href="https://youtu.be/H5IlmYmEDKk?t=2585">Using <strong>SPIFFE</strong> and <strong>SPIRE</strong> to ensure secure communications across hybrid infrastructure services</a><li><a href="https://www.youtube.com/watch?v=1TlEO0xO8jw&list=PLWsNZXV-gXVY_br7I8gz9q0Fijk4DoUxG&index=8&t=0s">Securing Grey Matter: <strong>SPIFFE</strong>/<strong>SPIRE</strong> in a Hybrid Mesh</a><li><a href="https://www.youtube.com/watch?v=TfnU1xD9EFY">Building Zero Trust-based Authentication in Healthcare with <strong>SPIRE</strong></a><li><a href=https://youtu.be/TOjb_imYuLE>Lessons Learned: Designing Scalable, PKI-based Authentication With <strong>SPIRE</strong> at ByteDance/TikTok</a></ul><h2 id=use-the-source>Use The Source</h2><p><a href=https://assets.zerotohero.dev/spire-rocks/3092102c-18cf-4658-b918-862d93ca2ec2/fizz-infra.zip>Here‚Äôs the zip archive of the project that we‚Äôve used in the demo video</a> (<em>32KB</em>). There are other manifest files that are not part of the demo. Yet, I‚Äôm keeping them to give a more complete view of the system that we are working with.<blockquote><p><strong>Aside</strong><p>In the source code archive, I have not included Kubernetes Secret manifests for obvious reasons‚Äîalso, after reading this article, who needs secrets anyway.<p><strong>¬Ø\_(„ÉÑ)_/¬Ø</strong>.</blockquote><h2 id=references-and-further-reading>References and Further Reading</h2><p>Here is some additional ‚Äú<em>bedtime reading</em>‚Äù for those who want to dig into the concept further.<h3 id=kubernetes-concepts-covered-in-the-video>Kubernetes Concepts Covered in the Video</h3><ul><li><a href=https://aws.amazon.com/eks/>Amazon Elastic Kubernetes Service (<strong><em>EKS</em></strong>)</a><li><a href=https://kubernetes.io/>Kubernetes</a><li><a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/><strong>Namespace</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/><strong>DaemonSet</strong></a><li><a href=https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/><strong>StatefulSet</strong>s</a><li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/>Configure <strong>ServiceAccount</strong>s for <strong>Pod</strong>s</a><li><a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>Using <strong>RBAC</strong> Authorization</a><li><a href=https://medium.com/@hajsanad/kubernetes-token-review-and-authentication-56e06cc55ed3>Kubernetes <strong>Token Review API</strong> and <strong>Authentication</strong></a><li><a href=https://kubernetes.io/docs/concepts/configuration/configmap/><strong>ConfigMap</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/configuration/secret/><strong>Secret</strong>s</a><li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>Configure <strong>Liveness</strong>, <strong>Readiness</strong>, and <strong>Startup</strong> Probes</a><li><a href=https://kubernetes.io/docs/concepts/services-networking/service/><strong>Service</strong></a><li><a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/><strong>Deployment</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/workloads/pods/><strong>Pod</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/><strong>Persistent Volume</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/storage/volumes/><strong>Volume</strong>s</a><li><a href=https://kubernetes.io/docs/concepts/architecture/nodes/><strong>Node</strong>s</a></ul><h3 id=spiffe-and-spire-fundamentals>SPIFFE and SPIRE Fundamentals</h3><ul><li><a href=https://spiffe.io/docs/latest/spiffe-about/spiffe-concepts/><strong>SPIFFE</strong> Concepts</a><li><a href=https://spiffe.io/docs/latest/spire-about/spire-concepts/><strong>SPIRE</strong> Concepts</a><li><a href=https://github.com/spiffe/spiffe/blob/main/standards/SPIFFE_Workload_API.md><strong>SPIFFE</strong> Workload API</a><li><a href=https://spiffe.io/docs/latest/deploying/svids/>Working With <strong>SVID</strong>s</a><li><a href=https://spiffe.io/docs/latest/planning/extending/>Extending <strong>SPIRE</strong></a><li><a href=https://github.com/spiffe/go-spiffe><strong>go-spiffe</strong>: Golang Library for <strong>SPIFFE</strong> Support</a></ul><h3 id=key-concepts>Key Concepts</h3><ul><li><a href=https://csrc.nist.gov/publications/detail/sp/800-207/final><strong>Zero Trust</strong> Architecture</a><li><a href=https://en.wikipedia.org/wiki/Zero_trust_security_model><strong>Zero Trust</strong> Security Model</a><li><a href=https://en.wikipedia.org/wiki/Trust_boundary>Trust Boundary</a><li><a href=https://en.wikipedia.org/wiki/Information_security>Information Security</a><li><a href=https://en.wikipedia.org/wiki/Public_key_infrastructure>Public Key Infrastructure (<em>PKI</em>)</a><li><a href=https://knowledge.digicert.com/solution/SO16297.html>How Certificate Chains Work</a><li><a href=https://kubernetes.io/>Kubernetes</a><li><a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a><li><a href=https://grpc.io/><strong>gRPC</strong>: A Universal RPC Framework</a><li><a href=https://en.wikipedia.org/wiki/Unix_domain_socket>Unix Domain Sockets</a><li><a href=https://en.wikipedia.org/wiki/Inter-process_communication>Inter-Process Communication</a><li><a href=https://www.redhat.com/en/topics/devops/what-is-ci-cd>What is CI/CD?</a></ul><h3 id=algorithms-and-standards>Algorithms and Standards</h3><ul><li><a href=https://en.wikipedia.org/wiki/X.509>X.509</a><li><a href=https://github.com/spiffe/spiffe/blob/main/standards/X509-SVID.md>X.509 <strong>SVID</strong></a><li><a href="https://en.wikipedia.org/wiki/Shamir's_Secret_Sharing">Shamir‚Äôs Secret Sharing Algorithm</a><li><a href=https://en.wikipedia.org/wiki/Certificate_revocation_list>Certificate Revocation Lists (<em>CRL</em>)</a><li><a href=https://people.csail.mit.edu/rivest/pubs/Riv98b.pdf>Can we eliminate <strong>CRL</strong>s?</a></ul><h3 id=related-technologies>Related Technologies</h3><ul><li><a href=https://www.vaultproject.io/docs/concepts/seal>How Vault Seals/Unseals Using Shamir‚Äôs Secret Sharing Algorithm</a><li><a href=https://en.wikipedia.org/wiki/Hardware_security_module><strong>HSM</strong>: Hardware Security Module</a><li><a href=https://aws.amazon.com/cloudhsm/>AWS Cloud HSM</a><li><a href=https://github.com/IBM/istio-spire>Istio identity with <strong>SPIFFE</strong> and <strong>SPIRE</strong></a><li><a href=https://www.openpolicyagent.org/><strong>OPA</strong>: Open Policy Agent</a><li><a href=https://certificate.transparency.dev/>Certificate Transparency</a><li><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html>AWS Instance Metadata and User Data</a><li><a href=https://aws.amazon.com/eks/>Amazon <strong>EKS</strong></a><li><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>Amazon Machine Images (<em>AMI</em>)</a><li><a href=https://cloud.google.com/security/encryption-in-transit/application-layer-transport-security/>ALTS: Application Layer Transport Security</a><li><a href=https://engineering.fb.com/2019/05/29/security/service-encryption/>Building Facebook‚Äôs Service Encryption</a><li><a href="https://www.youtube.com/watch?v=15H5uCj1hlE">Automated Bootstrapping of Secrets & Identity in the Cloud</a><li><a href=https://12factor.net/>The Twelve Factor App</a></ul><h2 id=key-terms>Key Terms</h2><p>Here is an non-exhaustive list of the key terms and phrases covered in this article and video. Of course, if you check the **References and Further Reading ** section above, you will find a lot more. Yet, it‚Äôs an excellent start to get acquainted with these and do more profound research around them.<h3 id=zero-trust-1>Zero Trust</h3><p>A security concept centered on the idea that organizations should not automatically trust anything based on whether a service is running inside or outside a network boundary and must verify everything trying to connect to its systems before granting access.<h3 id=authentication>Authentication</h3><p>The process of verifying the identity of a user or a system. Answers: ‚ÄúWhat are you?‚Äù.<h3 id=authorization>Authorization</h3><p>The process of determining the permissions of a user or a system over a resource. Answers: ‚ÄúWhat can you do?‚Äù.<h3 id=node-worker>Node/Worker</h3><p>A logical or physical entity that runs computational workloads.<h3 id=workload>Workload</h3><p>A workload is a single piece of software deployed with a particular configuration for a single purpose that can consist of multiple running instances, all of which perform the same task.<h3 id=attestation>Attestation</h3><p>In the context of <strong>SPIRE</strong>, attestation is asserting specific properties of a <strong>Node</strong> or <strong>Workload</strong>.<h3 id=spiffe-id>SPIFFE ID</h3><p>A string that uniquely identifies a workload, e.g. <code>spiffe://fizzbuzz.pro/service/idm</code>.<h3 id=svid-spiffe-verifiable-identity-document>SVID (<em>SPIFFE Verifiable Identity Document</em>)</h3><p>A document with which a workload proves its identity. An <strong>SVID</strong> contains a <strong>SPIFFE ID</strong>.<h3 id=trust-bootstrap>Trust Bootstrap</h3><p>Establishing Trust in a service or system.<h3 id=trust-domain>Trust Domain</h3><p>Corresponds to the Trust Root of a system. A <strong>SPIFFE</strong> <strong>trust domain</strong> is an identity namespace that is backed by an issuing authority.<h3 id=root-of-trust>Root of Trust</h3><p>A source in which another trust is built on.<h3 id=signing>Signing</h3><p>The addition of a digital signature for verifying the authenticity of a message or document.<h3 id=mutual-tls-mtls>Mutual TLS (<em>mTLS</em>)</h3><p>A cryptographic protocol that ensures that the network traffic is both secure and trusted in both directions between a client and server.<h3 id=public-key-cryptography-asymmetric-cryptography>Public-key cryptography (<em>asymmetric cryptography</em>)</h3><p>A cryptographic system that uses pairs of keys (<em><strong>private</strong> keys and <strong>public</strong> keys</em>). One key encrypts data, while the other key is used to decrypt the data. <strong>For example, X.509 Digital Certificates</strong> are created using public-key cryptography.<h3 id=pki-public-key-infrastructure>PKI (<em>Public Key Infrastructure</em>)</h3><p>A set of policies, procedures, and tools used to create, manage, and distribute digital certificates.<h3 id=x-509>X.509</h3><p>A widely used standard format for public-key certificates. These certificates are used in many internet protocols, including TLS/SSL.<h3 id=x509-svid>X509-SVID</h3><p>The <strong>X.509</strong> representation of an <strong>SVID</strong>.<h3 id=kernel>Kernel</h3><p>The central part of an operating system, which manages the memory, CPU, and device operations.<h3 id=hardening>Hardening</h3><p>The process of putting a system through a sequence of actions to increase its security posture, including patching, updating configuration, and limiting network access.<h3 id=hardware-security-module-hsm>Hardware Security Module (<em>HSM</em>)</h3><p>A dedicated cryptographic processor designed to manage and safeguard sensitive keys.<h3 id=key-management-service-kms>Key Management Service (<em>KMS</em>)</h3><p>A system that manages cryptographic keys. It deals with generating, exchange, storing, and revocation of keys.<h2 id=conclusion>Conclusion</h2><p>In this article, we‚Äôve seen how hard it is to manage service identity across clusters at scale. We also had a demo video showing how you can install <strong>SPIRE</strong> on an <strong>AWS EKS</strong> Kubernetes cluster. In the video, we also consumed the <strong>SPIRE Agent</strong>‚Äôs <strong>Workload API</strong>s to get <strong>SVID</strong>s in no time.<p>When it comes to identity federation, <strong>SPIFFE</strong> and its reference implementation <strong>SPIRE</strong> solve many cross-cutting concerns. Some of these common problems are <strong>secret management</strong>, secret creation, secret sharing, and <strong>secret invalidation</strong>. With <strong>SPIRE</strong>, you don‚Äôt need to trust the network or create firewall rules and access control lists.<p>Using the foundation that we created in this article, we‚Äôll create a service to service <strong>mTLS</strong> communication channel in the follow-up articles.<p>Until then‚Ä¶ May the source be with you ü¶Ñ.<hr><h2 id=section-contents>Section Contents</h2><ul><li><p><strong>‚ñ∂ Setting Up SPIRE on EKS in Less Than Ten Minutes</strong></p><li><p><a href=https://zerotohero.dev/spire/spike/shamir-secrets-sharing/>Shamir‚Äôs Secret Sharing Scheme with SPIFFE and SPIKE</a></p><li><p><a href=https://zerotohero.dev/spire/mtls/>mTLS with SPIRE</a></p></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://zerotohero.dev/tags/spiffe/>SPIFFE</a><li><a href=https://zerotohero.dev/tags/spire/>SPIRE</a><li><a href=https://zerotohero.dev/tags/kubernetes/>kubernetes</a><li><a href=https://zerotohero.dev/tags/security/>security</a><li><a href=https://zerotohero.dev/tags/secrets-management/>secrets-management</a></ul><nav class=paginav></nav></footer></article></main><footer class=footer><span>¬© <a href=https://zerotohero.dev>Volkan √ñz√ßelik</a> and <a href=/vadideki-geyik/team>Team Geyik</a></span><br><br> The content on this website is distributed under a <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en>CC-BY-NC-SA 4.0 license</a>.<br><br><a href=/about/privacy>Privacy Policy</a> | <a href=/about/contact>Contact</a><br><br><br></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });</script><script>var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };</script><script>document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })</script><script>document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';
        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                var content = codeblock.textContent;
                if(codeblock.firstChild.tagName == 'TABLE') {
                    content = Array(...codeblock.firstChild.getElementsByTagName('span')).map((span) => { return span.textContent; }).join('');
                }
                navigator.clipboard.writeText(content);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });</script>